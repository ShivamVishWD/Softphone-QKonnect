<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Keywords" content="Qkonnect, qkonnect cti, cti, html cti, WebRTC CTI, sip call, SIP Calling, Call Center, Call Service, Softphone" />
    <meta name="Description" content="Qkonnect CTI tool developed by Quadrafort and Made for enhance your calling services by softphone" />
    <meta name="author" content="Shivam Vishwakarma" />
	<title>Phone View</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="assets/css/global.css" type="text/css"/>
</head>
<body>
    <div class="power-by-section">
        <table>
            <tr>
                <td>
                    <label class="power-bt-text">Powered By</label>
                </td>
                <td>
                    <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="36.3303mm" height="10.1607mm" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 1770.18 488.35" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xodm="http://www.corel.com/coreldraw/odm/2003">
                        <defs>
                          <style type="text/css">
                            .fil5 {
                              fill: #606062;
                              fill-rule: nonzero;
                            }
            
                            .fil6 {
                              fill: #EA396E;
                              fill-rule: nonzero;
                            }
            
                            .fil4 {
                              fill: url(#id0);
                            }
            
                            .fil2 {
                              fill: url(#id1);
                            }
            
                            .fil0 {
                              fill: url(#id2);
                            }
            
                            .fil1 {
                              fill: url(#id3);
                            }
            
                            .fil3 {
                              fill: url(#id4);
                            }
                          </style>
                          <linearGradient id="id0" gradientUnits="userSpaceOnUse" x1="263.95" y1="317.69" x2="434" y2="456.14">
                            <stop offset="0" style="stop-opacity:1; stop-color:#00A859"></stop>
                            <stop offset="1" style="stop-opacity:1; stop-color:#CCE2A6"></stop>
                          </linearGradient>
                          <linearGradient id="id1" gradientUnits="userSpaceOnUse" x1="310.68" y1="155.57" x2="417.7" y2="298.61">
                            <stop offset="0" style="stop-opacity:1; stop-color:#FBB131"></stop>
                            <stop offset="0.619608" style="stop-opacity:1; stop-color:#FBC535"></stop>
                            <stop offset="1" style="stop-opacity:1; stop-color:#FBDA39"></stop>
                          </linearGradient>
                          <linearGradient id="id2" gradientUnits="userSpaceOnUse" x1="165.08" y1="146.83" x2="429.02" y2="196.74">
                            <stop offset="0" style="stop-opacity:1; stop-color:#F15D39"></stop>
                            <stop offset="1" style="stop-opacity:1; stop-color:#F89833"></stop>
                          </linearGradient>
                          <linearGradient id="id3" gradientUnits="userSpaceOnUse" x1="230.99" y1="454.8" x2="155.81" y2="114.74">
                            <stop offset="0" style="stop-opacity:1; stop-color:#8B3A8C"></stop>
                            <stop offset="1" style="stop-opacity:1; stop-color:#EA396E"></stop>
                          </linearGradient>
                          <linearGradient id="id4" gradientUnits="userSpaceOnUse" xlink:href="#id2" x1="331.76" y1="297.08" x2="387.01" y2="335.97">
                          </linearGradient>
                        </defs>
                        <g id="Layer_x0020_1">
                          <metadata id="CorelCorpID_0Corel-Layer"></metadata>
                          <g id="_2667983795824">
                            <g>
                              <g>
                                <polygon class="fil0" points="244.74,103.44 488.07,244.44 488.34,244.17 244.17,0 238.53,5.64 103.43,244.74 "></polygon>
                                <polygon class="fil1" points="103.43,244.74 238.53,5.64 -0,244.17 244.17,488.35 275.79,456.73 276.83,454.68 278.92,385.22 261.46,367.06 243.61,384.91 "></polygon>
                                <path class="fil2" d="M244.74 103.44l140.17 140.17 -41.36 80.78 32.29 32.29 112.23 -112.23 -243.33 -141.01zm56.04 304.49l-23.94 46.76 -0.03 1.03 35.65 -35.64 -11.68 -12.14z"></path>
                                <path class="fil3" d="M384.91 243.61l-61.07 61.07 19.71 19.71 41.36 -80.78zm-105.99 141.61l-2.09 69.47 23.94 -46.76 -21.85 -22.71z"></path>
                              </g>
                              <polygon class="fil4" points="336.99,429.37 220.08,307.84 312.37,307.84 470.82,466.29 "></polygon>
                            </g>
                            <g>
                              <path class="fil5" d="M617.87 352.94l-44.92 0 0 -221.72 44.92 0 0 221.72zm62.25 -108.46l63.85 108.46 -49.41 0 -37.87 -74.77 -2.25 -7.7 -4.49 6.42 -17.33 18.29c-2.36,-14.76 -1.39,-28.24 2.89,-40.43 4.28,-12.19 10.27,-23.11 17.97,-32.73l28.88 -34.98 51.66 0 -53.91 57.44z"></path>
                              <path class="fil5" d="M846.67 357.12c-15.08,0 -29.15,-3.42 -42.19,-10.21 -13.05,-6.74 -23.58,-16.69 -31.66,-29.68 -8.08,-12.94 -12.14,-28.77 -12.14,-47.38 0,-15.08 2.67,-28.13 8.13,-39.09 5.35,-10.97 12.41,-19.95 21.07,-27.01 8.66,-7.06 18.02,-12.3 28.02,-15.72 9.95,-3.42 19.57,-5.13 28.77,-5.13 17.01,0 31.98,3.69 44.87,11.07 12.89,7.38 22.94,17.59 30.22,30.7 7.27,13.1 10.91,28.18 10.91,45.19 0,13.58 -2.46,25.78 -7.38,36.58 -4.92,10.8 -11.5,20 -19.74,27.49 -8.24,7.54 -17.43,13.32 -27.65,17.27 -10.21,3.96 -20.64,5.94 -31.23,5.94zm0 -32.73c8.34,0 15.35,-2.46 21.02,-7.38 5.67,-4.92 9.95,-11.5 12.84,-19.74 2.89,-8.24 4.33,-17.38 4.33,-27.43 0,-9.95 -1.44,-19.04 -4.33,-27.27 -2.89,-8.24 -7.17,-14.82 -12.84,-19.68 -5.67,-4.87 -12.68,-7.27 -21.02,-7.27 -8.34,0 -15.4,2.41 -21.07,7.27 -5.72,4.87 -10.05,11.45 -12.99,19.68 -2.94,8.24 -4.44,17.33 -4.44,27.27 0,16.04 3.53,29.15 10.54,39.31 7,10.16 16.31,15.24 27.97,15.24z"></path>
                              <path class="fil5" d="M1066.15 352.94l0 -117.77c0,-5.35 -1.07,-9.73 -3.26,-13.16 -2.19,-3.42 -6.04,-5.13 -11.5,-5.13 -2.03,0 -4.01,0.27 -5.94,0.8 -1.92,0.53 -4.44,0.91 -7.54,1.12 -5.13,0.32 -9.47,-1.87 -12.89,-6.52 -3.48,-4.65 -6.79,-9.52 -9.89,-14.65 10.59,-5.67 19.89,-9.57 27.92,-11.66 8.02,-2.03 15.72,-3.1 23.1,-3.1 7.38,0 14.49,1.87 21.34,5.61 6.85,3.74 12.46,9.41 16.79,17.06 4.28,7.65 6.47,17.33 6.47,28.99l0 118.41 -44.6 0zm-103.64 0l0 -125.47c0,-5.99 -0.38,-12.35 -1.18,-19.09 -0.8,-6.74 -2.14,-13.85 -3.96,-21.34l37.22 0c5.13,5.78 8.56,11.5 10.27,17.17 1.71,5.67 2.57,11.71 2.57,18.13l0 130.6 -44.92 0z"></path>
                              <path class="fil5" d="M1251.62 352.94l0 -117.77c0,-5.35 -1.07,-9.73 -3.26,-13.16 -2.19,-3.42 -6.04,-5.13 -11.5,-5.13 -2.03,0 -4.01,0.27 -5.94,0.8 -1.92,0.53 -4.44,0.91 -7.54,1.12 -5.13,0.32 -9.47,-1.87 -12.89,-6.52 -3.48,-4.65 -6.79,-9.52 -9.89,-14.65 10.59,-5.67 19.89,-9.57 27.92,-11.66 8.02,-2.03 15.72,-3.1 23.1,-3.1 7.38,0 14.49,1.87 21.34,5.61 6.85,3.74 12.46,9.41 16.79,17.06 4.28,7.65 6.47,17.33 6.47,28.99l0 118.41 -44.6 0zm-103.64 0l0 -125.47c0,-5.99 -0.38,-12.35 -1.18,-19.09 -0.8,-6.74 -2.14,-13.85 -3.96,-21.34l37.22 0c5.13,5.78 8.56,11.5 10.27,17.17 1.71,5.67 2.57,11.71 2.57,18.13l0 130.6 -44.92 0z"></path>
                              <path class="fil5" d="M1415.6 357.12c-14.65,0 -27.33,-2.62 -38.02,-7.81 -10.7,-5.13 -19.52,-12.14 -26.37,-20.86 -6.9,-8.71 -12.03,-18.39 -15.35,-29.04 -3.31,-10.64 -4.97,-21.34 -4.97,-32.14 0,-17.65 3.8,-32.78 11.34,-45.4 7.54,-12.62 17.65,-22.3 30.38,-28.99 12.73,-6.63 26.85,-10 42.36,-10 11.87,0 22.67,2.35 32.35,6.95 9.68,4.65 17.59,11.23 23.75,19.68 6.15,8.45 9.89,18.45 11.23,30 1.29,11.55 -0.37,24.23 -5.08,38.02l-89.85 0c2.25,-7.38 5.61,-13.58 10.11,-18.72 4.49,-5.03 9.47,-7.59 14.92,-7.59l28.56 0c0.86,-6.52 0.27,-12.62 -1.77,-18.29 -2.03,-5.67 -5.29,-10.27 -9.84,-13.75 -4.6,-3.48 -10.11,-5.19 -16.63,-5.19 -5.88,0 -11.71,1.77 -17.49,5.3 -5.78,3.53 -10.54,9.09 -14.33,16.68 -3.8,7.59 -5.72,17.49 -5.72,29.68 0,12.3 1.92,22.78 5.72,31.5 3.8,8.77 9.09,15.4 15.88,20 6.74,4.6 14.65,6.9 23.64,6.9 7.38,0 14.7,-0.96 21.98,-2.83 7.27,-1.87 15.56,-4.87 24.87,-9.04l11.23 29.84c-11.55,5.46 -22.41,9.36 -32.62,11.66 -10.21,2.25 -20.32,3.42 -30.27,3.42z"></path>
                              <path class="fil5" d="M1592.4 357.12c-14.87,0 -28.83,-3 -41.93,-8.99 -13.1,-5.99 -23.75,-15.4 -31.88,-28.24 -8.13,-12.84 -12.19,-29.52 -12.19,-50.06 0,-19.36 4.07,-35.51 12.19,-48.4 8.13,-12.89 18.77,-22.52 31.88,-28.93 13.1,-6.42 27.06,-9.63 41.93,-9.63 5.78,0 12.09,0.59 18.93,1.66 6.85,1.18 13.48,2.94 19.89,5.4l-10.91 29.84c-5.13,-1.28 -10.16,-2.25 -15.13,-2.89 -5.03,-0.64 -9.25,-0.96 -12.78,-0.96 -7.7,0 -14.44,2.14 -20.22,6.47 -5.78,4.33 -10.27,10.54 -13.48,18.61 -3.21,8.13 -4.81,17.7 -4.81,28.83 0,11.23 1.61,20.86 4.81,28.93 3.21,8.13 7.7,14.34 13.48,18.72 5.78,4.39 12.51,6.58 20.22,6.58 4.49,0 9.31,-0.64 14.44,-1.87 5.13,-1.23 11.13,-3.16 17.97,-5.83l10.91 29.52c-8.35,3.85 -16.2,6.68 -23.58,8.5 -7.38,1.82 -13.96,2.73 -19.74,2.73z"></path>
                              <path class="fil6" d="M1754.13 218.81c-6.2,0 -11.45,-1.66 -15.73,-4.97 -4.28,-3.32 -7.75,-7.44 -10.32,-12.36 -2.67,-4.92 -4.65,-9.73 -6.04,-14.44l46.53 0 0 31.77 -14.44 0z"></path>
                              <path class="fil5" d="M1731.67 357.12c-20.32,0 -35.88,-5.83 -46.69,-17.49 -10.8,-11.66 -16.2,-28.4 -16.2,-50.22l0 -70.59 -26.63 0 0 -25.35 26.63 -6.42 0 -39.47 42.36 -13.8 0 155.63c0,10.91 2.3,19.42 6.9,25.51 4.6,6.1 10.64,9.15 18.13,9.15 3.1,0 6.63,-0.32 10.59,-0.96 3.96,-0.64 8.66,-1.93 14.12,-3.85l9.3 29.2c-8.02,2.68 -15.08,4.81 -21.23,6.37 -6.2,1.5 -11.93,2.3 -17.27,2.3z"></path>
                            </g>
                          </g>
                        </g>
                    </svg>
                </td>
            </tr>
        </table>
    </div>
    <div class="dial-pad-wrap">
        <div class="left-pan">
            <div class="calling">
                <div class="title fadeIn animated infinite">Calling</div>
                <div class="connected-timer">00:00:00</div>
                <div class="photo bounceInDown animated">
                    <img src="https://cdn.pixabay.com/photo/2020/07/01/12/58/icon-5359553_1280.png" alt="">
                </div>
                <div class="name rubberBand animated" id="contact-name">Unknown</div>
                <div class="number" id="contact-number"></div>
                <div class="call-connected-options hide">
                    <button class="hold-btn action-btn" id="hold-btn" onclick="sipToggleHoldResume()" disabled="true" title="Hold/Unhold">
                        <img src="./assets/images/pause-call.png" alt="Call-Hold">
                    </button>
                    <button class="mute-btn action-btn" id="mute-btn" onclick="sipToggleMute()" disabled="true" title="Mute/Unmute">
                        <img src="./assets/images/mute-microphone.png" alt="Call-Mute">
                    </button>
                </div>
                <div class="call-end show bounceInUp animated">
                    <button type="button" class="btn btn-hangup" onclick="sipHangUp()"><img class="hangup-icon" src="assets/images/phone.png"/></button>
                </div>
                <div class="call-recieve hide">
                    <button type="button" class="btn btn-danger btn-xl btn-round" id="reject-call"><img src="assets/images/end-call.png" style="height: 20px; width: 20px"/></button>
                    <button type="button" class="btn btn-success btn-xl btn-round" id="pick-call"><img src="assets/images/call.png" style="height: 20px; width: 20px"/></button>
                </div>
                <div id="show-in-web">
                    <div style="margin-top: 6px; margin-bottom: 4px;">
                        <button onclick="showCallDivert('transfer')" class="call-divert-btn active" id="call-transfer-tab">Call Transfer</button>
                        <button onclick="showCallDivert('conferance')" class="call-divert-btn" id="call-conferance-tab">Call Conference</button>
                        <button onclick="showCallDivert('dtmf-transfer')" class="call-divert-btn" id="call-dtmf-tab">DTMF Transfer</button>
                    </div>
                    <div class="dialpad-call" id="call-transfer-section" style="margin-top: 10px;">
                        <label style="margin-bottom: 0.5px; font-size: 12px">Select Agent for Call Transfer</label>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <select name="agents-for-transfer" id="agents-for-transfer" style="font-size: 14px;">
                                <option value="">--Select Agent--</option>
                            </select>
                            <button onclick="getUsers()"><i class="fa fa-refresh"></i></button>
                        </div>
                        <button type="button" onclick="callTransfer('transfer')" class="action-click-btn" style="margin-top: 8px;">Transfer</button>
                    </div>
                    <div class="dialpad-call" id="call-conferance-section" style="margin-top: 10px; display: none;">
                        <label style="margin-bottom: 0.5px; font-size: 12px">Select Agents for Conference</label>
                        <select name="agents-for-conferance" id="agents-for-conferance" style="font-size: 14px;" multiple>
                            <option value="">--Select Agent--</option>
                        </select>
                        <button type="button" onclick="callTransfer('conferance')" class="action-click-btn" style="margin-top: 8px;">Conference</button>
                    </div>
                    <center>
                        <div class="dialpad-call" id="call-dtmf-section" style="width:250; height:240; display: none;">
                            <table class="dtmf-keypad-table">
                                <tr><td><input type="button" style="width: 33%" class="btn" value="1" onclick="sipSendDTMF('1');" /><input type="button" style="width: 33%" class="btn" value="2" onclick="sipSendDTMF('2');" /><input type="button" style="width: 33%" class="btn" value="3" onclick="sipSendDTMF('3');" /></td></tr>
                                <tr><td><input type="button" style="width: 33%" class="btn" value="4" onclick="sipSendDTMF('4');" /><input type="button" style="width: 33%" class="btn" value="5" onclick="sipSendDTMF('5');" /><input type="button" style="width: 33%" class="btn" value="6" onclick="sipSendDTMF('6');" /></td></tr>
                                <tr><td><input type="button" style="width: 33%" class="btn" value="7" onclick="sipSendDTMF('7');" /><input type="button" style="width: 33%" class="btn" value="8" onclick="sipSendDTMF('8');" /><input type="button" style="width: 33%" class="btn" value="9" onclick="sipSendDTMF('9');" /></td></tr>
                                <tr><td><input type="button" style="width: 33%" class="btn" value="*" onclick="sipSendDTMF('*');" /><input type="button" style="width: 33%" class="btn" value="0" onclick="sipSendDTMF('0');" /><input type="button" style="width: 33%" class="btn" value="#" onclick="sipSendDTMF('#');" /></td></tr>
                            </table>
                        </div>
                    </center>
                </div>
                <button onclick="newCase()" id="new-case-btn" class="action-click-btn" style="margin-top: 10px;">New Case</button>
            </div>
        </div>
        <div class="dial-pad hide">
            <center><p id="alert-msg">Waiting for connection</p></center>
            <div class="agent-connect-status">
                <select name="agent-status" id="agent-status" class="form-select" onchange="handleAgentStatus()">
                    <option value="Online">Online</option>
                    <option value="Away/Off-Line/Logged Out">Away/Off-Line/Logged Out</option>
                    <option value="Activity / Training">Activity / Training</option>
                    <option value="Bio-Break">Bio-Break</option>
                    <option value="Tea-Break">Tea-Break</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Meeting">Meeting</option>
                </select>
            </div>
            <input type="text" class="form-control dial-screen" placeholder="Type Mobile no. here" id="dialed-number" onkeyup="checkNumber(event)">
            <div class="dial-table">
                <div class="dial-table-row">
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="1">
                            <div class="dial-key">1</div>
                            <div class="dial-sub-key">&nbsp;</div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="2">
                            <div class="dial-key">2</div>
                            <div class="dial-sub-key">abc</div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="3">
                            <div class="dial-key">3</div>
                            <div class="dial-sub-key">def</div>
                        </div>
                    </div>
                </div>
                <div class="dial-table-row">
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="4">
                            <div class="dial-key">4</div>
                            <div class="dial-sub-key">ghi</div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="5">
                            <div class="dial-key">5</div>
                            <div class="dial-sub-key">jkl</div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="6">
                            <div class="dial-key">6</div>
                            <div class="dial-sub-key">mno</div>
                        </div>
                    </div>
                </div>
                <div class="dial-table-row">
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="7">
                            <div class="dial-key">7</div>
                            <div class="dial-sub-key">pqrs</div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="8">
                            <div class="dial-key">8</div>
                            <div class="dial-sub-key">tuv</div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="9">
                            <div class="dial-key">9</div>
                            <div class="dial-sub-key">wxyz</div>
                        </div>
                    </div>
                </div>
                <div class="dial-table-row">
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="*">
                            <div class="dial-key">*</div>
                            <div class="dial-sub-key">&nbsp;</div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="0">
                            <div class="dial-key">0</div>
                            <div class="dial-sub-key">+</div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap" data-key="#">
                            <div class="dial-key">#</div>
                            <div class="dial-sub-key">&nbsp;</div>
                        </div>
                    </div>
                </div>
                <div class="dial-table-row no-sub-key">
                    <div class="dial-table-col">
                        <div class="dial-key-wrap handleBtn" data-key="refresh" title="Refresh Softphone">
                            <div class="dial-key"><i class="fa fa-refresh"></i></div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap handleBtn" data-key="call" title="Call" id="call-init">
                            <div class="dial-key"><i class="fa fa-phone"></i></div>
                        </div>
                    </div>
                    <div class="dial-table-col">
                        <div class="dial-key-wrap handleBtn" data-key="back" title="Erase Number">
                            <div class="dial-key"><i class="fa fa-long-arrow-left"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <center style="margin-top: 5px;">
                <p id="permissionStatus">Permission status will be displayed here.</p>
                <button onclick="checkMicPermissions()">Check Permission</button>
                <button onclick="requestMicrophonePermission()">Request Permission</button>
            </center>
        </div>
        <div class="dispotition hide">
            <h4 class="text-center mb-3">Call End</h4>
            <form>
                <div class="form-group mb-2">
                    <label for="call-was" class="form-label">Call was</label>
                    <select class="form-select" id="call-was" onchange="handleSelectChange()">
                        <option value="Partial Response">Partial Response</option>
                        <option value="Good Response">Good Response</option>
                        <option value="Not Reachable">Not Reachable</option>
                        <option value="Busy">Busy</option>
                        <option value="Out of Service">Out of Service</option>
                        <option value="Invalid Number">Invalid Number</option>
                        <option value="Call Transferred">Call Transferred</option>
                        <option value="Callback">Callback</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group mb-2" id="callback-input-box" style="display: none;">
                    <label for="call-desc" class="form-label">Callback Time</label>
                    <input type="datetime-local" class="form-control" id="callback-datetime">
                </div>
                <div class="form-group mb-2">
                    <label for="call-desc" class="form-label">Call Description <span style="color: red; font-weight: bold;">*<span style="font-size: 10px;">(Mendatory)</span></span></label>
                    <textarea id="call-desc" cols="30" rows="5" class="form-control"></textarea>
                </div>
                <div class="form-group mb-2">
                    <input type="text" class="form-control" id="caller-number" readonly>
                </div>
                <div class="disposition-btn-section">
                    <button type="button" class="btn btn-primary btn-md center mt-3" id="disposition-submit-btn" onclick="handleDispositionSubmit()">Submit</button>
                    <a href="javascript:void(0)" id="open-dialepad-btn">Open Dialpad</a>
                </div>
            </form>
        </div>
    </div>
    <!-- Audios -->
    <audio id="audio_remote" autoplay="autoplay"> </audio>
    <audio id="ringtone" loop src="assets/media/sounds/ringtone.wav"> </audio>
    <audio id="ringbacktone" loop src="assets/media/sounds/ringbacktone.wav"> </audio>
    <audio id="dtmfTone" src="assets/media/sounds/dtmf.wav"> </audio>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="assets/js/dialer.js"></script>
    <script src="SIPml-api.js?svn=252" type="text/javascript"></script>
    <script type="text/javascript">
        var credentialObj = {
            expert_disable_video: 'false',
            identity_password: 'rec%20@24!23',
            expert_websocket_server_url: 'wss://rec3.qkonnect.io:7443',
            identity_impi: userExtension,
            expert_sip_outboundproxy_url: '',
            // identity_impu: 'sip:53106@rec3.qkonnect.io',
            identity_impu: `sip:${userExtension}@rec3.qkonnect.io`,
            identity_display_name: userExtension,
            expert_disable_early_ims: 'false',
            expert_video_size: '',
            expert_enable_media_caching: 'false',
            // expert_ice_servers: '[{"url":"stun:stun.l.google.com:19302"},{"urls":"turn:relay.backups.cz:3478","username":"webrtc","credential":"webrtc"}]',
            expert_ice_servers: '[{"url":"stun:stun.l.google.com:19302"}]',
            expert_disable_callbtn_options: 'false',
            identity_realm: 'free',
            expert_bandwidth: '',
            expert_enable_rtcweb_breaker: 'false',
            expert_disable_debug: 'false',
        };

        var userExtension = null;
        var callInitStatus = "Nothing";
        var userAPIKey = null;
        var callType = '';
        var timerInterval;
        var elapsedTime = 0; // in seconds
        var stunServer = '[{"url":"stun:stun.l.google.com:19302"}]';

        var urlParams = new URLSearchParams(window.location.search);
        console.log("urlParams : ",urlParams);
        var getApiKey = urlParams.get('apikey');
        console.log("getApiKey : ",getApiKey);
        if(getApiKey && getApiKey != null && getApiKey != undefined && getApiKey != ''){
            userAPIKey = getApiKey.trim();
        }

        var getExtension = urlParams.get('extension');
        console.log('getExtension : ',getExtension);
        if(getExtension && getExtension != null && getExtension != ''){
            userExtension = getExtension.trim();
        }

        var dialingNumber = urlParams.get('callerno');
        console.log('dialingNumber : ',dialingNumber);
        if(dialingNumber && dialingNumber != null && dialingNumber != '' && dialingNumber.length == 10){
            
            document.querySelector('.dial-pad').classList.remove('show')
            document.querySelector('.dial-pad').classList.add('hide')

            $(".left-pan").addClass("active");
            $(".calling").fadeIn(100);

            checkProviders(userExtension, userAPIKey);
        }

        var hasApiKey = urlParams.has('apikey') && urlParams.get('apikey').trim() !== '';
        var hasExtension = urlParams.has('extension') && urlParams.get('extension').trim() !== '';

        var agentDetail = null;

        var fromPlatform = "qkonnect";
        if(!hasExtension){
            fromPlatform = "salesforce";
        }

        if(hasApiKey && hasExtension && userExtension != null && userAPIKey != null){
            checkProviders(userExtension, userAPIKey);
        }

        var uiPlatform = urlParams.get('platform');
        if(uiPlatform == "app"){
            document.getElementById("show-in-web").style.display = "none";
        }

        async function checkProviders(extension, apikey, from='salesforce', dialNumber=''){
            try{

                if(extension == "" || apikey == ""){
                    document.querySelector(".alert-msg").innerText = "Unable to Connect(Forbidden), try again";
                    document.querySelector(".alert-msg").style.color = "red";
                }

                credentialObj.identity_impi = extension;
                credentialObj.identity_display_name = extension;
                credentialObj.identity_impu = `sip:${extension}@rec3.qkonnect.io`;

                const myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                const raw = JSON.stringify({
                "api_key": apikey,
                "extension": extension
                });

                const requestOptions = {
                method: "POST",
                headers: myHeaders,
                body: raw,
                redirect: "follow"
                };

                fetch("https://qkonnect.io/api/aashirwadSalesforceGetAgentStatus.php", requestOptions)
                .then((response) => response.json())
                .then((result) => {
                    console.log('provider result :',result)
                    agentDetail = result;
                    // stunServer = result.ivr_details.account_id == "619679" ? [{url:"stun:global.stun.twilio.com:3478"}] : [{url:"stun:stun.l.google.com:19302"}];
                    // credentialObj.expert_ice_servers = result.ivr_details.account_id == "619679" ? '[{"url":"stun:global.stun.twilio.com:3478"}]' : '[{"url":"stun:stun.l.google.com:19302"}]';
                    stunServer = [{url:"stun:stun.l.google.com:19302"}];
                    credentialObj.expert_ice_servers ='[{"url":"stun:stun.l.google.com:19302"}]';
                    if(result.status == '200' && result.agent_call_status == "0" && result.agent_status == 'online'){
                        document.querySelector(".dial-pad").classList.add('show')
                        if(from == 'qkonnect'){
                            document.querySelector("#new-case-btn").style.display = 'none';
                        }
                        setTimeout(()=>{
                            sipRegister();
                            //getUsers();
                        }, 2000);
                    }else if(result.status == '200' && result.agent_call_status == "0" && result.agent_status != 'online' && from == 'qkonnect') {
                        document.getElementById("alert-msg").innerText = "Agent is "+result.agent_status;
                        document.getElementById("alert-msg").style.color = "red";
                        document.querySelector(".dial-pad").classList.add('show')
                        document.querySelector('.dial-key-wrap[data-key="call"]').setAttribute("data-key", "no-call");
                    }else if(result.status == '200' && result.agent_call_status == "0" && result.agent_status != 'online' && from == 'salesforce') {
                        document.getElementById("alert-msg").innerText = "Agent is "+result.agent_status + ", retrying...";
                        document.querySelector(".dial-pad").classList.add('show');
                        authUser("1", "0", true);
                    }else if(result.status == '200' && result.agent_call_status == "1"){
                        document.getElementById("alert-msg").innerText = "Agent already on a call";
                        document.getElementById("alert-msg").style.color = "goldenrod";
                        document.querySelector(".dial-pad").classList.add('show')
                        document.querySelector('.dial-key-wrap[data-key="call"]').setAttribute("data-key", "no-call");
                    }else if(from == 'qkonnect'){
                        document.querySelector(".dial-pad").classList.add('show');
                        document.getElementById("alert-msg").innerText = "Unable to connect, agent is "+result.agent_status;
                        document.getElementById("alert-msg").style.color = "red";
                        document.querySelector('.dial-key-wrap[data-key="call"]').setAttribute("data-key", "no-call");
                    }else if(from == 'salesforce'){
                        authUser("1", "0", true);
                    }
                })
                .catch((error) => {
                    console.error(error);
                    document.querySelector(".alert-msg").innerText = "Unable to Connect(Forbidden), try again";
                    document.querySelector(".alert-msg").style.color = "red";
                });
            }catch(error){
                console.log("Error Providers : ",error);
            }
        }

        function setUnsetUserActive(logType = "login"){
            const userDetail = window.localStorage.getItem('userdetail') != null ? JSON.parse(window.localStorage.getItem('userdetail')) : null;

            if(logType == 'login'){
                if(userDetail == null){
                    window.localStorage.setItem('userdetail', JSON.stringify(agentDetail));
                }else if(agentDetail.agent_name == userDetail.agent_name){
                    document.getElementById("alert-msg").innerText = "Agent active on another panel";
                    document.getElementById("alert-msg").style.color = "goldenrod";
                    document.querySelector(".dial-pad").classList.add('show')
                    document.querySelector('.dial-key-wrap[data-key="call"]').setAttribute("data-key", "no-call");
                }
            }else{
                window.localStorage.removeItem('userdetail');
            }
        }

        var idOfObject = '';

        async function authUser(agentStatus = "0", agentCallStatus = "0", reconnect = false){
            try{
                let status = document.getElementById("agent-status").value;
                const obj={
                    "api_key": userAPIKey,
                    "extension": userExtension,
                    "crm_status": agentStatus,
                    "agent_call_status": agentCallStatus,
                    "crm_status_reason": agentStatus == "0" ? status : "",
                }
                console.log("Agent Status Log Object : ",obj);
                let response = await fetch("https://qkonnect.io/api/aashirwadSalesforceAgentStatus.php", {
                    method: "POST",
                    Headers: {
                        "Accept": '*/*',
                        'Content-Type': 'application/json',
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow-Headers":"X-Requested-With"
                    },
                    body: JSON.stringify(obj)
                })

                response = await response.json();
                console.log("response api : ",response)

                const params = {Status__c: agentStatus == "1" ? "Online" : "Offline", Log_Description__c: ""};

                args = {
                    apexClass: 'AgentsActivity',
                    methodName: 'logAgentStatus',
                    methodParams: `body=${JSON.stringify(params)}`,
                    callback: function(result) {
                        if (result.success) {
                            console.log('Result Agent Log: ',result);
                        } else {
                            console.log('ResultError Agent Status: ',result.errors);
                        }
                    }
                };
                // Call APEX Class to get
                sforce.opencti.runApex(args) 

                if(agentStatus == "1" && agentCallStatus == "0" && reconnect){
                    setTimeout(() => {
                        sipRegister();
                    }, 2000);
                }
            }catch(error){
                console.log("catch error : ",error)
            }
        }
    </script>
    <script type="text/javascript">
        var dialPad = document.querySelector(".dial-pad");
        var disposition = document.querySelector(".dispotition");
        var callingPanel = document.querySelector(".left-pan");
        var hangupBtn = document.querySelector(".call-end");
        var callRecieveBtns = document.querySelector(".call-recieve");
        function showDialer(phoneNumber=""){
            disposition.classList.remove("show")
            disposition.classList.add("hide")
    
            document.getElementById("dialed-number").value = phoneNumber;
            
            dialPad.classList.remove('hide')
            dialPad.classList.add("show")
    
            callingPanel.classList.remove("active")
        }
        
        document.querySelector("#reject-call").addEventListener("click", ()=>{
            sipHangUp();
            document.querySelector(".left-pan").classList.remove("active");
            dialPad.classList.remove('hide')
            dialPad.classList.add("show")
        });
    
        document.querySelector("#pick-call").addEventListener("click", ()=>{
            let phoneNo = document.getElementById("dialed-number").value;
            sipCall('call-audio',phoneNo);
            document.querySelector(".title").innerHTML = "Connected";
            callRecieveBtns.classList.add("hide")
            callRecieveBtns.classList.remove("show")
    
            hangupBtn.classList.remove("hide")
            hangupBtn.classList.add("show")
        })

        function handleSelectChange() {
            var selectElement = document.getElementById("call-was");
            var selectedValue = selectElement.value;
    
            if (selectedValue === "Callback") {
                document.getElementById("callback-input-box").style.display = "block";
            }else{
                document.getElementById("callback-input-box").style.display = "none";
            }
        }

        document.getElementById("open-dialepad-btn").addEventListener("click", ()=>{
            document.querySelector(".dispotition").classList.remove("show")
            document.querySelector(".dispotition").classList.add("hide")

            document.querySelector(".dial-pad").classList.remove("hide")
            document.querySelector(".dial-pad").classList.add("show");

            document.querySelector("#callback-datetime").value = "";
            document.querySelector("#call-desc").value = "";

            authUser("1", "0");
        })

        function generateRandomWithDatetime(n) {
            let randomData = [];
            for (let i = 0; i < n; i++) {
                let randomDatetime = new Date();
                let randomNumber = Math.random();
                randomData.push({ datetime: randomDatetime, number: randomNumber });
            }
            return randomData;
        }
        
        // Example usage:
        const randomData = generateRandomWithDatetime(5);
        randomData.forEach(data => {
            console.log(data);
        });

        async function handleAgentStatus(){
            let status = document.getElementById("agent-status").value;

            if(status == "Online"){
                console.log('sipRegister called');
                authUser("1", "0", true);
                callInitStatus = "Nothing";
                sipRegister();
            }else{
                authUser("0", "0");
                console.log('sipUnRegister called');
                sipUnRegister();
            }
        }

        function generateCustomCallId() {
            let timestamp = new Date().getTime().toString();
            let randomNumber = Math.floor(Math.random() * 90000) + 10000; // Generate random number between 10000 and 99999
            return timestamp + "-" + randomNumber.toString();
        }

        async function handleDispositionSubmit(){

            document.getElementById("disposition-submit-btn").disabled = true;
            document.getElementById("disposition-submit-btn").innerText = "Submitting...";

            if(document.querySelector("#call-was").value == ""){
                document.getElementById("disposition-submit-btn").disabled = false;
                document.getElementById("disposition-submit-btn").innerText = "Submit";
                return;
            }
            if(document.querySelector("#call-desc").value == ""){
                document.getElementById("disposition-submit-btn").disabled = false;
                document.getElementById("disposition-submit-btn").innerText = "Submit";
                return;
            }
            if(document.querySelector("#call-was").value == "Callback" && document.querySelector("#callback-datetime").value == ""){
                document.getElementById("disposition-submit-btn").disabled = false;
                document.getElementById("disposition-submit-btn").innerText = "Submit";
                return;
            }
            const callLog_CallID = await getCallIdOfCallNumber();
            console.log("callLog_CallID : ",callLog_CallID);
            const params = { callId: callLog_CallID, disposition: document.querySelector("#call-was").value, notes: document.querySelector("#call-desc").value, id: idOfObject };
            console.log(params, 'params disposition');
            args = {
                apexClass: 'CreateCallLog',
                methodName: 'insertUpdateCallLog',
                methodParams: `body=${JSON.stringify(params)}`,
                callback: function(result) {
                    if (result.success) {
                        console.log('Result Disposition: ',result);
                        document.querySelector("#call-desc").value = "";
                        document.getElementById("disposition-submit-btn").disabled = false;
                        document.getElementById("disposition-submit-btn").innerText = "Submit";
                        if(document.querySelector("#call-was").value == "Callback"){
                            callBackDisposition();
                        }
                        authUser("1", "0");
                        showDialer("");
                    } else {
                        console.log('ResultError Extension: ',result.errors);
                        document.getElementById("disposition-submit-btn").disabled = false;
                        document.getElementById("disposition-submit-btn").innerText = "Submit";
                    }
                }
            };
            // Call APEX Class to get
            sforce.opencti.runApex(args) 
        }

        async function callBackDisposition(){
            let data = {
                "api_key": userAPIKey,
                "extension": userExtension,
                "caller": "",
                "callBackDate": "",
                "callBackTime": ""
            }
            console.log(document.querySelector("#caller-number").value, 'caller no');
            if(document.querySelector("#call-was").value == "Callback"){
                data.caller = String(document.querySelector("#caller-number").value);
                data.callBackDate = String(document.querySelector("#callback-datetime").value).split("T")[0];
                data.callBackTime = String(document.querySelector("#callback-datetime").value).split("T")[1]+":00";
                console.log(data, 'data for callback')
                let response = await fetch("https://qkonnect.io/api/ashirwaadSalesforceReminder.php", {
                    method: "POST",
                    Headers: {
                        "Accept": '*/*',
                        'Content-Type': 'application/json',
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow-Headers":"X-Requested-With"
                    },
                    body: JSON.stringify(data)
                })
                console.log(response, 'callback raw response')
                response = await response.json();
                console.log("callback json response : ",response);
            }
        }

        function getCallIdOfCallNumber(){
            return new Promise(async(resolve, reject) => {
                try{
                    const phoneNo = String(document.querySelector("#caller-number").value);
                    const data = JSON.stringify({
                        "api_key": userAPIKey,
                        "callerNumber": phoneNo
                    });

                    const requestOptions = {
                        method: "POST",
                        Headers: {
                            "Accept": '*/*',
                            'Content-Type': 'application/json',
                            "Access-Control-Allow-Origin": "*",
                            "Access-Control-Allow-Headers":"X-Requested-With"
                        },
                        body: data,
                        redirect: "follow"
                    };

                    fetch("https://qkonnect.io/api/aashirwadSalesforceGetCallId.php", requestOptions)
                    .then((response) => response.json())
                    .then((result) => {
                        console.log(result, 'get Call Id');
                        console.log(result.status, 'get Call Id Status');
                        if(result.status == "200" || result.status == 200 || result.callId != null || result.callId != ""){
                            resolve(result?.callId);
                        }else{
                            resolve(generateCustomCallId());
                        }
                    })
                    .catch((error) => {
                        console.error(error)
                        resolve(generateCustomCallId());
                    });
                }catch(error){
                    resolve(generateCustomCallId());
                }
            })
        }

        function checkNumber(event){
            let dialedNo = event.target.value;
            event.target.value = String(dialedNo).replace(/\D/g,'');

            if(String(dialedNo).length > 10){
                event.target.value = String(dialedNo).substring(0, 10);
            }
            
        }

        function showCallDivert(showType){
            console.log(showType, 'show type')
            if(showType == 'transfer'){
                document.querySelector("#call-conferance-section").style.display = "none";
                document.querySelector("#call-dtmf-section").style.display = "none";
                document.querySelector("#call-transfer-section").style.display = "block";
                document.querySelector("#call-conferance-tab").classList.remove('active');
                document.querySelector('#call-dtmf-tab').classList.remove('active');
                document.querySelector("#call-transfer-tab").classList.add('active');
                getUsers();
            }else if(showType == 'conferance'){
                document.querySelector("#call-transfer-section").style.display = "none";
                document.querySelector("#call-dtmf-section").style.display = "none";
                document.querySelector("#call-conferance-section").style.display = "block";
                document.querySelector("#call-transfer-tab").classList.remove('active');
                document.querySelector('#call-dtmf-tab').classList.remove('active');
                document.querySelector("#call-conferance-tab").classList.add('active');
                getUsers();
            }else if(showType == 'dtmf-transfer'){
                document.querySelector("#call-transfer-section").style.display = "none";
                document.querySelector("#call-conferance-section").style.display = "none";
                document.querySelector("#call-dtmf-section").style.display = "block";
                document.querySelector("#call-transfer-tab").classList.remove('active');
                document.querySelector("#call-conferance-tab").classList.remove('active');
                document.querySelector('#call-dtmf-tab').classList.add('active');
            }
        }

        function checkMicPermissions() {
            navigator.permissions.query({ name: 'microphone' })
            .then(function(permissionStatus) {
                document.getElementById('permissionStatus').innerText = `Microphone and Sound permission: ${permissionStatus.state}`;
            })
            .catch(function(err) {
                console.error('Error checking microphone permission:', err);
            });
        }

        function requestMicrophonePermission() {
            navigator.mediaDevices.getUserMedia({ audio: true, video: true })
            .then(function(stream) {
                document.getElementById('permissionStatus').innerText = "Microphone and Sound access granted!";
                // Stop the stream to release resources
                stream.getTracks().forEach(track => track.stop());
            })
            .catch(function(err) {
                let errorMessage = `Microphone permission denied: ${err.name}`;
                if (err.name === 'NotAllowedError') {
                    errorMessage += " - Permission might be denied due to HTTPS requirements or browser settings.";
                }
                document.getElementById('permissionStatus').innerText = errorMessage;
                console.error('Error requesting microphone permission:', err);
            });
        }

        // Format the time in HH:MM:SS
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            // Add leading zero if needed
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Function to update the timer on the UI
        function updateTimerDisplay() {
            const timerElement = document.querySelector('.connected-timer');
            timerElement.innerText = formatTime(elapsedTime);
        }

        // Start the call and the timer
        function startCallTimer() {
            elapsedTime = 0; // reset time
            updateTimerDisplay();

            // Start the timer, increment every second
            timerInterval = setInterval(() => {
                elapsedTime++;
                updateTimerDisplay();
            }, 1000);

            console.log('Call started');
        }

        // End the call and stop the timer
        function endCallTimer() {
            if (timerInterval) {
                clearInterval(timerInterval); // Stop the timer
                timerInterval = null; // Reset interval
            }

            const timerElement = document.querySelector('.connected-timer');
            timerElement.innerText = "00:00:00";

            console.log('Call ended');
        }


    </script>
    <script src="https://quadraforttechnologies-4c-dev-ed.lightning.force.com/support/api/56.0/interaction.js" type="text/javascript"></script>
    <script src="https://quadraforttechnologies-4c-dev-ed.lightning.force.com/support/api/56.0/lightning/opencti_min.js" type="text/javascript"></script>
    <script type="text/javascript">
        /*
        args = {
            callback: function(result) {
                console.log(result, "Click to dial result");
            }
        };
        sforce.opencti.enableClickToDial(args)
        */
        args = {
            apexClass: 'GetUserInfo',
            methodName: 'getExtension',
            methodParams: '',
            callback: function(result) {
                if (result.success) {
                    console.log('Result Extension: ',result);
                    userExtension = result.returnValue.runApex;
                    userExtension = userExtension != null ? userExtension.trim() : '';
                    checkProviders(userExtension, userAPIKey, 'salesforce');
                    /*
                    credentialObj.identity_impi = userExtension;
                    credentialObj.identity_display_name = userExtension;
                    credentialObj.identity_impu = `sip:${userExtension}@rec3.qkonnect.io`;
                    //authUser();
                    getUsers();
                    setTimeout(()=>{
                        sipRegister();
                    }, 2000);
                    */
                } else {
                    console.log('ResultError Extension: ',result.errors);
                }
            }
        };
        // Call APEX Class to get
        sforce.opencti.runApex(args) 


        async function getUsers(){

            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            const raw = JSON.stringify({
                "api_key": userAPIKey
            });

            const requestOptions = {
                method: "POST",
                headers: myHeaders,
                body: raw,
                redirect: "follow",
            };

            fetch("https://qkonnect.io/api/getActiveAgentList.php", requestOptions)
            .then((response) => response.json())
            .then((result) => {
                console.log(result, "extension api response")
                if(result.status == "200" && result.active_agent_list.length > 0){
                    result.active_agent_list.sort((a, b) => {
                        if (a.crm_status === "1" && a.call_status === "0") return -1; // Available
                        if (a.crm_status === "1" && a.call_status === "1") return 0;  // Busy
                        if (a.crm_status === "0") return 1; // Offline
                    });
                    let option = '<option value="">--Select Agent--</option>';
                    for(let item of result.active_agent_list){
                        if(String(item.extension) != String(userExtension)){
                            const status = item.crm_status == "1" && item.call_status == "0" ? '(Available)' : item.crm_status == "1" && item.call_status == "1" ? '(Busy)' : '(Offline)';
                            const isDisable = (item.crm_status == "1" && item.call_status == "1") || item.crm_status == "0" && 'disabled';
                            option += `<option style="display: flex; justify-content: space-between; align-items: center;" value="${item.extension}" ${isDisable}><label style="font-weight: 500;">${item.extension} - ${item.agent_name}</label> ${status}</option>`
                        }
                    }
                    document.querySelector("#agents-for-transfer").innerHTML = option;
                    document.querySelector('#agents-for-conferance').innerHTML = option;
                }
            })
            .catch((error) => console.error(error));
            /*
            if(getExtension && getExtension != null && getExtension != ''){
                
                const myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                const raw = JSON.stringify({
                    "api_key": userAPIKey
                });

                const requestOptions = {
                    method: "POST",
                    headers: myHeaders,
                    body: raw,
                    redirect: "follow",
                };

                fetch("https://qkonnect.io/api/getActiveAgentList.php", requestOptions)
                .then((response) => response.json())
                .then((result) => {
                    console.log(result, "extension api response")
                    if(result.status == "200" && result.active_agent_list.length > 0){
                        let option = '<option value="">--Select Agent--</option>';
                        for(let item of result.active_agent_list){
                            if(String(item.extension) != String(userExtension)){
                                option += '<option value="'+item.extension+'">'+item.extension+' - '+item.agent_name+'</option>'
                            }
                        }
                        document.querySelector("#agents-for-transfer").innerHTML = option;
                        document.querySelector('#agents-for-conferance').innerHTML = option;
                    }
                })
                .catch((error) => console.error(error));
            }else{

                args = {
                    apexClass: 'GetAllUsers',
                    methodName: 'getUsersHaveExtension',
                    methodParams: '',
                    callback: function(result) {
                        if (result.success) {
                            console.log('Result Users : ', result);
                            const responseString = result.returnValue.runApex;

                            const response = JSON.parse(responseString);

                            if(response.status == 200){
                                let option = '<option value="">--Select Agent--</option>';
                                for(let item of response.users){
                                    option += '<option value="'+item.Extension+'">'+item.Extension+' - '+item.Name+'</option>'
                                }
                                document.querySelector("#agents-for-transfer").innerHTML = option;
                                document.querySelector('#agents-for-conferance').innerHTML = option;
                            }
                        } else {
                            console.log('ResultError Extension: ',result.errors);
                        }
                    }
                };
                // Call APEX Class to get
                sforce.opencti.runApex(args) 
            }
            */
        }
        
        /*
        var urlParams = new URLSearchParams(window.location.search);
        console.log("urlParams : ",urlParams)
        var getExtension = urlParams.get('extension');

        if(getExtension && getExtension != null && getExtension != ''){
            userExtension = getExtension;
            credentialObj.identity_impi = getExtension;
            credentialObj.identity_display_name = getExtension;
            credentialObj.identity_impu = `sip:${getExtension}@rec3.qkonnect.io`;
            document.querySelector("#new-case-btn").style.display = 'none';
            // authUser();
            getUsers();
            setTimeout(()=>{
                sipRegister();
            }, 2000);
        }
        */
        
        args = {
            listener: function(result) {
                console.log(result,"CTI Listener Result");
                console.log("result nbew  :",result.number);    
                if(result && Object.keys(result).length > 0){
                    document.querySelector(".title").innerHTML = "Calling";
                    document.getElementById("contact-number").innerText = result?.number;
                    document.getElementById("contact-name").innerText = result?.recordName;
                    document.getElementById("dialed-number").value = result?.number;
                    document.getElementById("caller-number").value = result?.number;
    
                    callRecieveBtns.classList.add("hide")
                    callRecieveBtns.classList.remove("show")
    
                    hangupBtn.classList.remove("hide")
                    hangupBtn.classList.add("show")
                    DialPad.call();
                    sipCall("call-audio", result?.number)
                }
                args = {
                    visible: true,
                    callback: function(result) {
                        if (result.success) {
                            console.log(result.returnValue);
                        } else {
                            console.log(result.errors);
                        }
                    }
                };
                sforce.opencti.setSoftphonePanelVisibility(args)
                
                
                args = {
                    apexClass: 'GetRecordId',
                    methodName: 'getAccountId',
                    methodParams: 'phoneNumber='+result.number,
                    callback: function(result) {
                        if (result.success) {
                            console.log('Result GetRecordId : ',result)
                            console.log('Result: ',JSON.parse(result.returnValue.runApex).id);
                            let rcrdId = JSON.parse(result.returnValue.runApex).id
                            idOfObject = JSON.parse(result.returnValue.runApex).id;
                            
                            sforce.opencti.screenPop({
                            type: sforce.opencti.SCREENPOP_TYPE.SOBJECT,
                            params: {
                                        recordId: rcrdId
                                    }
                            });
    
                            
                            
                        } else {
                            console.log('ResultError : ',result.errors);
                        }
                    }
                };
                // Call APEX Class to get
                sforce.opencti.runApex(args)    
            }
        };
        sforce.opencti.onClickToDial(args);
        
    </script>
    <script type="text/javascript">

        window.localStorage.setItem('org.doubango.expert.disable_video', credentialObj.expert_disable_video);
        window.localStorage.setItem('org.doubango.identity.password', credentialObj.identity_password);
        window.localStorage.setItem('org.doubango.expert.websocket_server_url', credentialObj.expert_websocket_server_url);
        window.localStorage.setItem('org.doubango.identity.impi', credentialObj.identity_impi);
        window.localStorage.setItem('org.doubango.expert.sip_outboundproxy_url', credentialObj.expert_sip_outboundproxy_url);
        window.localStorage.setItem('org.doubango.identity.impu', credentialObj.identity_impu);
        window.localStorage.setItem('org.doubango.identity.display_name', credentialObj.identity_display_name);
        window.localStorage.setItem('org.doubango.expert.disable_early_ims', credentialObj.expert_disable_early_ims);
        window.localStorage.setItem('org.doubango.expert.video_size', credentialObj.expert_video_size);
        window.localStorage.setItem('org.doubango.expert.enable_media_caching', credentialObj.expert_enable_media_caching);
        window.localStorage.setItem('org.doubango.expert.ice_servers', credentialObj.expert_ice_servers);
        window.localStorage.setItem('org.doubango.expert.disable_callbtn_options', credentialObj.expert_disable_callbtn_options);
        window.localStorage.setItem('org.doubango.identity.realm', credentialObj.identity_realm);
        window.localStorage.setItem('org.doubango.expert.bandwidth', credentialObj.expert_bandwidth);
        window.localStorage.setItem('org.doubango.expert.enable_rtcweb_breaker', credentialObj.expert_enable_rtcweb_breaker);
        window.localStorage.setItem('org.doubango.expert.disable_debug', credentialObj.expert_disable_debug);
    
        // to avoid caching
        //if (window.location.href.indexOf("svn=") == -1) {
        //    window.location.href += (window.location.href.indexOf("?") == -1 ? "svn=236" : "&svn=229");
        //}
    
        var sTransferNumber;
        var oRingTone, oRingbackTone;
        var oSipStack, oSipSessionRegister, oSipSessionCall, oSipSessionTransferCall;
        var videoRemote, videoLocal, audioRemote;
        var bFullScreen = false;
        var oNotifICall;
        var bDisableVideo = false;
        var viewVideoLocal, viewVideoRemote, viewLocalScreencast; // <video> (webrtc) or <div> (webrtc4all)
        var oConfigCall;
        var oReadyStateTimer;
    
        C =
        {
            divKeyPadWidth: 220
        };
    
        window.onload = function () {
            console.log('oConfigCall value : ',oConfigCall);
            window.console && window.console.info && window.console.info("location=" + window.location);
    
            videoLocal = document.getElementById("video_local");
            videoRemote = document.getElementById("video_remote");
            audioRemote = document.getElementById("audio_remote");
    
            document.onkeyup = onKeyUp;
            document.body.onkeyup = onKeyUp;
            // divCallCtrl.onmousemove = onDivCallCtrlMouseMove;
    
            // set debug level
            SIPml.setDebugLevel((window.localStorage && window.localStorage.getItem('org.doubango.expert.disable_debug') == "true") ? "error" : "info");
    
            loadCredentials();
            loadCallOptions();
    
            // Initialize call button
            uiBtnCallSetText("Call");
    
            var getPVal = function (PName) {
                var query = window.location.search.substring(1);
                var vars = query.split('&');
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split('=');
                    if (decodeURIComponent(pair[0]) === PName) {
                        return decodeURIComponent(pair[1]);
                    }
                }
                return null;
            }
    
            var preInit = function () {
                console.log("Pre Init Function Called");
                // set default webrtc type (before initialization)
                var s_webrtc_type = getPVal("wt");
                var s_fps = getPVal("fps");
                var s_mvs = getPVal("mvs"); // maxVideoSize
                var s_mbwu = getPVal("mbwu"); // maxBandwidthUp (kbps)
                var s_mbwd = getPVal("mbwd"); // maxBandwidthUp (kbps)
                var s_za = getPVal("za"); // ZeroArtifacts
                var s_ndb = getPVal("ndb"); // NativeDebug
    
                if (s_webrtc_type) SIPml.setWebRtcType(s_webrtc_type);

                console.log("Setting up oConfigCall variable");
                oConfigCall = {
                    audio_remote: audioRemote,
                    video_local: viewVideoLocal,
                    video_remote: viewVideoRemote,
                    screencast_window_id: 0x00000000, // entire desktop
                    bandwidth: { audio: undefined, video: undefined },
                    video_size: { minWidth: undefined, minHeight: undefined, maxWidth: undefined, maxHeight: undefined },
                    events_listener: { events: '*', listener: onSipEventSession },
                    sip_caps: [
                                    { name: '+g.oma.sip-im' },
                                    { name: 'language', value: '\"en,fr\"' }
                    ]
                };

                console.log('oConfigCall initialize : ',oConfigCall);
    
                // initialize SIPML5
                SIPml.init(postInit);
    
                // set other options after initialization
                if (s_fps) SIPml.setFps(parseFloat(s_fps));
                if (s_mvs) SIPml.setMaxVideoSize(s_mvs);
                if (s_mbwu) SIPml.setMaxBandwidthUp(parseFloat(s_mbwu));
                if (s_mbwd) SIPml.setMaxBandwidthDown(parseFloat(s_mbwd));
                if (s_za) SIPml.setZeroArtifacts(s_za === "true");
                if (s_ndb == "true") SIPml.startNativeDebug();
    
                //var rinningApps = SIPml.getRunningApps();
                //var _rinningApps = Base64.decode(rinningApps);
                //tsk_utils_log_info(_rinningApps);
            }
    
            oReadyStateTimer = setInterval(function () {
                if (document.readyState === "complete") {
                    clearInterval(oReadyStateTimer);
                    // initialize SIPML5
                    preInit();
                }
            },
            500);
    
            /*if (document.readyState === "complete") {
                preInit();
            }
            else {
                document.onreadystatechange = function () {
                        if (document.readyState === "complete") {
                        preInit();
                    }
                }
            }*/
        };
    
        function postInit() {
            console.log("Post Init Function Called");
            // check for WebRTC support
            if (!SIPml.isWebRtcSupported()) {
                // is it chrome?
                if (SIPml.getNavigatorFriendlyName() == 'chrome') {
                    if (confirm("You're using an old Chrome version or WebRTC is not enabled.\nDo you want to see how to enable WebRTC?")) {
                        window.location = 'http://www.webrtc.org/running-the-demos';
                    }
                    else {
                        window.location = "index.html";
                    }
                    return;
                }
                else {
                    if (confirm("webrtc-everywhere extension is not installed. Do you want to install it?\nIMPORTANT: You must restart your browser after the installation.")) {
                        window.location = 'https://github.com/sarandogou/webrtc-everywhere';
                    }
                    else {
                        // Must do nothing: give the user the chance to accept the extension
                        // window.location = "index.html";
                    }
                }
            }
    
            // checks for WebSocket support
            if (!SIPml.isWebSocketSupported()) {
                if (confirm('Your browser don\'t support WebSockets.\nDo you want to download a WebSocket-capable browser?')) {
                    window.location = 'https://www.google.com/intl/en/chrome/browser/';
                }
                else {
                    window.location = "index.html";
                }
                return;
            }
    
            // FIXME: displays must be per session
            viewVideoLocal = videoLocal;
            viewVideoRemote = videoRemote;
    
            if (!SIPml.isWebRtcSupported()) {
                if (confirm('Your browser don\'t support WebRTC.\naudio/video calls will be disabled.\nDo you want to download a WebRTC-capable browser?')) {
                    window.location = 'https://www.google.com/intl/en/chrome/browser/';
                }
            }
    
            // btnRegister.disabled = false;
            document.body.style.cursor = 'default';
            console.log("Setting up oConfigCall variable");
            oConfigCall = {
                audio_remote: audioRemote,
                video_local: viewVideoLocal,
                video_remote: viewVideoRemote,
                screencast_window_id: 0x00000000, // entire desktop
                bandwidth: { audio: undefined, video: undefined },
                video_size: { minWidth: undefined, minHeight: undefined, maxWidth: undefined, maxHeight: undefined },
                events_listener: { events: '*', listener: onSipEventSession },
                sip_caps: [
                                { name: '+g.oma.sip-im' },
                                { name: 'language', value: '\"en,fr\"' }
                ]
            };

            console.log('oConfigCall initialize : ',oConfigCall);
        }
    
    
        function loadCallOptions() {
            if (window.localStorage) {
                var s_value;
                if ((s_value = window.localStorage.getItem('org.doubango.call.phone_number'))) // txtPhoneNumber.value = s_value;
                bDisableVideo = (window.localStorage.getItem('org.doubango.expert.disable_video') == "true");
    
                // txtCallStatus.innerHTML = '<i>Video ' + (bDisableVideo ? 'disabled' : 'enabled') + '</i>';
            }
        }
    
        function saveCallOptions() {
            if (window.localStorage) {
                // window.localStorage.setItem('org.doubango.call.phone_number', txtPhoneNumber.value);
                window.localStorage.setItem('org.doubango.expert.disable_video', bDisableVideo ? "true" : "false");
            }
        }
    
        function loadCredentials() {
            if (window.localStorage) {
                // IE retuns 'null' if not defined
                /*
                var s_value;
                if ((s_value = window.localStorage.getItem('org.doubango.identity.display_name'))) txtDisplayName.value = s_value;
                if ((s_value = window.localStorage.getItem('org.doubango.identity.impi'))) txtPrivateIdentity.value = s_value;
                if ((s_value = window.localStorage.getItem('org.doubango.identity.impu'))) txtPublicIdentity.value = s_value;
                if ((s_value = window.localStorage.getItem('org.doubango.identity.password'))) txtPassword.value = s_value;
                if ((s_value = window.localStorage.getItem('org.doubango.identity.realm'))) txtRealm.value = s_value;
                */
            }
            else {
                //txtDisplayName.value = "005";
                //txtPrivateIdentity.value = "005";
                //txtPublicIdentity.value = "sip:005@sip2sip.info";
                //txtPassword.value = "005";
                //txtRealm.value = "sip2sip.info";
                //txtPhoneNumber.value = "701020";
            }
        };
    
        function saveCredentials() {
            if (window.localStorage) {
                window.localStorage.setItem('org.doubango.identity.display_name', credentialObj.identity_display_name);
                window.localStorage.setItem('org.doubango.identity.impi', credentialObj.identity_impi);
                window.localStorage.setItem('org.doubango.identity.impu', credentialObj.identity_impu);
                window.localStorage.setItem('org.doubango.identity.password', credentialObj.identity_password);
                window.localStorage.setItem('org.doubango.identity.realm', credentialObj.identity_realm);
            }
        };
    
        // sends SIP REGISTER request to login
        function sipRegister() {
            // catch exception for IE (DOM not ready)
            try {
                console.log(tsip_uri, 'tsip_uri')
                var o_impu = tsip_uri.prototype.Parse(credentialObj?.identity_impu);
                if (!o_impu || !o_impu.s_user_name || !o_impu.s_host) {
                    // txtRegStatus.innerHTML = "<b>[" + txtPublicIdentity.value + "] is not a valid Public identity</b>";
                    // btnRegister.disabled = false;
                    //console.log('sip:53106@rec3.qkonnect.io is not a valid Public identity')
                    return;
                }
    
                // enable notifications if not already done
                if (window.webkitNotifications && window.webkitNotifications.checkPermission() != 0) {
                    window.webkitNotifications.requestPermission();
                }
    
                // save credentials
                saveCredentials();
    
                // update debug level to be sure new values will be used if the user haven't updated the page
                SIPml.setDebugLevel((window.localStorage && window.localStorage.getItem('org.doubango.expert.disable_debug') == "true") ? "error" : "info");
    
                // create SIP stack
                oSipStack = new SIPml.Stack({
                    realm: credentialObj.identity_realm,
                    impi: credentialObj.identity_impi,
                    impu: credentialObj.identity_impu,
                    password: credentialObj.identity_password,
                    display_name: credentialObj.identity_display_name,
                    websocket_proxy_url: (window.localStorage ? window.localStorage.getItem('org.doubango.expert.websocket_server_url') : null),
                    outbound_proxy_url: (window.localStorage ? window.localStorage.getItem('org.doubango.expert.sip_outboundproxy_url') : null),
                    ice_servers: (window.localStorage ? window.localStorage.getItem('org.doubango.expert.ice_servers') : null),
                    enable_rtcweb_breaker: (window.localStorage ? window.localStorage.getItem('org.doubango.expert.enable_rtcweb_breaker') == "true" : false),
                    events_listener: { events: '*', listener: onSipEventStack },
                    enable_early_ims: (window.localStorage ? window.localStorage.getItem('org.doubango.expert.disable_early_ims') != "true" : true), // Must be true unless you're using a real IMS network
                    enable_media_stream_cache: (window.localStorage ? window.localStorage.getItem('org.doubango.expert.enable_media_caching') == "true" : false),
                    bandwidth: (window.localStorage ? tsk_string_to_object(window.localStorage.getItem('org.doubango.expert.bandwidth')) : null), // could be redefined a session-level
                    video_size: (window.localStorage ? tsk_string_to_object(window.localStorage.getItem('org.doubango.expert.video_size')) : null), // could be redefined a session-level
                    sip_headers: [
                            { name: 'User-Agent', value: 'IM-client/OMA1.0 sipML5-v1.2016.03.04' },
                            { name: 'Organization', value: 'Doubango Telecom' }
                    ]
                });
                
                if (oSipStack.start() != 0) {
                    // txtRegStatus.innerHTML = '<b>Failed to start the SIP stack</b>';
                    console.log('Failed to start the SIP stack')
                }
                /*
                else {
                    document.getElementById("alert-msg").innerText = "Connected";
                    document.getElementById("alert-msg").style.color = "green";
                    return;
                }
                */
            }
            catch (e) {
                // txtRegStatus.innerHTML = "<b>2:" + e + "</b>";
                console.log('sipRegister catch error : ',e)
            }
            // btnRegister.disabled = false;
        }
    
        // sends SIP REGISTER (expires=0) to logout
        function sipUnRegister() {
            
            if (oSipStack) {
                oSipStack.stop(); // shutdown all sessions
            }
        }
    
        // makes a call (SIP INVITE)
        function sipCall(s_type, phone_number='') {
            if (oSipStack && !oSipSessionCall && !tsk_string_is_null_or_empty(phone_number)) {
                if (s_type == 'call-screenshare') {
                    if (!SIPml.isScreenShareSupported()) {
                        alert('Screen sharing not supported. Are you using chrome 26+?');
                        return;
                    }
                    if (!location.protocol.match('https')) {
                        if (confirm("Screen sharing requires https://. Do you want to be redirected?")) {
                            sipUnRegister();
                            window.location = 'https://ns313841.ovh.net/call.htm';
                        }
                        return;
                    }
                }
                // btnCall.disabled = true;
                // btnHangUp.disabled = false;
    
                if (window.localStorage) {
                    console.log('oConfigCall var : ',oConfigCall);
                    //if(oConfigCall && 'bandwidth' in oConfigCall){
                        oConfigCall.bandwidth = tsk_string_to_object(window.localStorage.getItem('org.doubango.expert.bandwidth')); // already defined at stack-level but redifined to use latest values
                    //}
                }
    
                // create call session
                oSipSessionCall = oSipStack.newSession(s_type, oConfigCall);
                // make call
                if (oSipSessionCall.call(phone_number) != 0) {
                    oSipSessionCall = null;
                    // txtCallStatus.value = 'Failed to make call';
                    // btnCall.disabled = false;
                    // btnHangUp.disabled = true;
                    console.log('Failed to make call')
                    return;
                }
                saveCallOptions();
            }
            else if (oSipSessionCall) {
                // txtCallStatus.innerHTML = '<i>Connecting...</i>';
                console.log('Connecting ....')
                oSipSessionCall.accept(oConfigCall);
            }
        }
    
        // Share entire desktop aor application using BFCP or WebRTC native implementation
        function sipShareScreen() {
            if (SIPml.getWebRtcType() === 'w4a') {
                // Sharing using BFCP -> requires an active session
                if (!oSipSessionCall) {
                    // txtCallStatus.innerHTML = '<i>No active session</i>';
                    console.log("No active session");
                    return;
                }
                if (oSipSessionCall.bfcpSharing) {
                    if (oSipSessionCall.stopBfcpShare(oConfigCall) != 0) {
                        // txtCallStatus.value = 'Failed to stop BFCP share';
                        console.log("Failed to stop BFCP share")
                    }
                    else {
                        oSipSessionCall.bfcpSharing = false;
                    }
                }
                else {
                    oConfigCall.screencast_window_id = 0x00000000;
                    if (oSipSessionCall.startBfcpShare(oConfigCall) != 0) {
                        // txtCallStatus.value = 'Failed to start BFCP share';
                    }
                    else {
                        oSipSessionCall.bfcpSharing = true;
                    }
                }
            }
            else {
                sipCall('call-screenshare');
            }
        }
    
        // transfers the call
        function sipTransfer(extNo='') {
            console.log("extension no : ",extNo);
            if (oSipSessionCall) {
                // var s_destination = prompt('Enter destination number', '');
                if (!tsk_string_is_null_or_empty(extNo)) {
                    //btnTransfer.disabled = true;
                    if (oSipSessionCall.transfer(extNo) != 0) {
                        console.log("Call transfer failed");
                        // txtCallStatus.innerHTML = '<i>Call transfer failed</i>';
                        // btnTransfer.disabled = false;
                        return;
                    }
                    console.log("Transfering the call.. ");
                    // txtCallStatus.innerHTML = '<i>Transfering the call...</i>';
                }
            }
        }
    
        // holds or resumes the call
        function sipToggleHoldResume() {
            if (oSipSessionCall) {
                var i_ret;
                console.log(oSipSessionCall.bHeld, 'oSipSessionCall.bHeld');
                //btnHoldResume.disabled = true;
                //txtCallStatus.innerHTML = oSipSessionCall.bHeld ? '<i>Resuming the call...</i>' : '<i>Holding the call...</i>';
                i_ret = oSipSessionCall.bHeld ? oSipSessionCall.resume() : oSipSessionCall.hold();
                console.log('i_ret : ',i_ret)
                if (i_ret != 0) {
                    document.querySelector(".title").innerHTML
                  //  txtCallStatus.innerHTML = '<i>Hold / Resume failed</i>';
                  //  btnHoldResume.disabled = false;
                    return;
                }
            }
        }
    
        // Mute or Unmute the call
        function sipToggleMute() {
            if (oSipSessionCall) {
                var i_ret;
                var bMute = !oSipSessionCall.bMute;
                console.log('bMute : ',bMute);
                if(bMute){
                    document.querySelector(".mute-btn").classList.add('active');
                }else{
                    document.querySelector(".mute-btn").classList.remove('active');
                }
                // txtCallStatus.innerHTML = bMute ? '<i>Mute the call...</i>' : '<i>Unmute the call...</i>';
                i_ret = oSipSessionCall.mute('audio'/*could be 'video'*/, bMute);
                if (i_ret != 0) {
                    // txtCallStatus.innerHTML = '<i>Mute / Unmute failed</i>';
                    return;
                }
                oSipSessionCall.bMute = bMute;
                //btnMute.value = bMute ? "Unmute" : "Mute";
            }
        }
    
        // terminates the call (SIP BYE or CANCEL)
        function sipHangUp() {
            if (oSipSessionCall) {
                // txtCallStatus.innerHTML = '<i>Terminating the call...</i>';
                console.log("Terminating the call...")
                oSipSessionCall.hangup({ events_listener: { events: '*', listener: onSipEventSession } });
            }
            console.log("callInitStatus : ",callInitStatus)
            if(callInitStatus == "Connected"){
                callInitStatus = "Call";
                document.querySelector(".title").innerHTML = "Calling";
                if(!dialingNumber){
                    document.querySelector(".dial-pad").classList.remove("show")
                    document.querySelector(".dial-pad").classList.add("hide")

                    document.querySelector(".dispotition").classList.add("show")
                    document.querySelector(".dispotition").classList.remove("hide")
                }

            }else if(callInitStatus == "Ringing"){
                callInitStatus = "Call";
                document.querySelector(".title").innerHTML = "Calling";
                if(!dialingNumber){
                    document.querySelector(".dial-pad").classList.add("show")
                    document.querySelector(".dial-pad").classList.remove("hide")

                    document.querySelector(".dispotition").classList.remove("show")
                    document.querySelector(".dispotition").classList.add("hide")
                }
            }

            var urlParams = new URLSearchParams(window.location.search);
            console.log("urlParams : ",urlParams)
            var getExtension = urlParams.get('extension');
            /*
            if(getExtension && getExtension != null && getExtension != ''){
                document.querySelector(".dispotition").classList.remove("show")
                document.querySelector(".dispotition").classList.add("hide")

                document.querySelector(".dial-pad").classList.add("show")
                document.querySelector(".dial-pad").classList.remove("hide")
            }
                */

            $(".left-pan").removeClass("active");
            $(".calling").fadeOut(100);
            $(".calling .name").html("Unknown");
            $(".calling .number").html("");

            document.querySelector(".call-connected-options").classList.remove("show");
            document.querySelector(".call-connected-options").classList.add("hide");
            document.querySelector(".mute-btn").classList.remove('active');
            document.getElementById('hold-btn').classList.remove('active');
            document.querySelector("#hold-btn").disabled = true;
            document.querySelector("#mute-btn").disabled = true;

            callType = "";
            endCallTimer();

            if(fromPlatform == 'qkonnect'){
                authUser("1", "0");
            }

            if(dialingNumber != null && dialingNumber != '' && dialingNumber.length == 10){
                console.log("c2cHangupedCall")
            }
        }
    
        function sipSendDTMF(c) {
            try {
                console.log('sipSendDTMF c:', c, 'oSipSessionCall:', oSipSessionCall);
                if (oSipSessionCall && c) {
                    console.log('calling oSipSessionCall.dtmf');
                    if (oSipSessionCall.dtmf(c) == 0) {
                        try { 
                            console.log('calling dtmfTone.play')
                            dtmfTone.play(); 
                        } catch (e) { 
                            console.log('Catch',e)  
                        }
                    } else {
                        console.log('c != 0',c);
                    }
                } else {
                    console.log('!oSipSessionCall && c',oSipSessionCall,c);
                }
            } catch (e) { 
                console.log('Catch2',e)
            }
        }
    
        function startRingTone() {
            try { ringtone.play(); }
            catch (e) { }
        }
    
        function stopRingTone() {
            try { ringtone.pause(); }
            catch (e) { }
        }
    
        function startRingbackTone() {
            try { ringbacktone.play(); }
            catch (e) { }
        }
    
        function stopRingbackTone() {
            try { ringbacktone.pause(); }
            catch (e) { }
        }
    
        function toggleFullScreen() {
            if (videoRemote.webkitSupportsFullscreen) {
                fullScreen(!videoRemote.webkitDisplayingFullscreen);
            }
            else {
                fullScreen(!bFullScreen);
            }
        }
    
        function openKeyPad() {
            /*
            divKeyPad.style.visibility = 'visible';
            divKeyPad.style.left = ((document.body.clientWidth - C.divKeyPadWidth) >> 1) + 'px';
            divKeyPad.style.top = '70px';
            divGlassPanel.style.visibility = 'visible';
            */
        }
    
        function closeKeyPad() {
            /*
            divKeyPad.style.left = '0px';
            divKeyPad.style.top = '0px';
            divKeyPad.style.visibility = 'hidden';
            divGlassPanel.style.visibility = 'hidden';
            */
        }
    
        function fullScreen(b_fs) {
            bFullScreen = b_fs;
            if (tsk_utils_have_webrtc4native() && bFullScreen && videoRemote.webkitSupportsFullscreen) {
                if (bFullScreen) {
                    videoRemote.webkitEnterFullScreen();
                }
                else {
                    videoRemote.webkitExitFullscreen();
                }
            }
            else {
                if (tsk_utils_have_webrtc4npapi()) {
                    try { if (window.__o_display_remote) window.__o_display_remote.setFullScreen(b_fs); }
                    catch (e) { 
                        // divVideo.setAttribute("class", b_fs ? "full-screen" : "normal-screen"); 
                    }
                }
                else {
                    // divVideo.setAttribute("class", b_fs ? "full-screen" : "normal-screen");
                }
            }
        }
    
        function showNotifICall(s_number) {
            // permission already asked when we registered
            if (window.webkitNotifications && window.webkitNotifications.checkPermission() == 0) {
                if (oNotifICall) {
                    oNotifICall.cancel();
                }
                oNotifICall = window.webkitNotifications.createNotification('images/sipml-34x39.png', 'Incaming call', 'Incoming call from ' + s_number);
                oNotifICall.onclose = function () { oNotifICall = null; };
                oNotifICall.show();
            }
        }
    
        function onKeyUp(evt) {
            evt = (evt || window.event);
            if (evt.keyCode == 27) {
                fullScreen(false);
            }
            else if (evt.ctrlKey && evt.shiftKey) { // CTRL + SHIFT
                if (evt.keyCode == 65 || evt.keyCode == 86) { // A (65) or V (86)
                    bDisableVideo = (evt.keyCode == 65);
                    // txtCallStatus.innerHTML = '<i>Video ' + (bDisableVideo ? 'disabled' : 'enabled') + '</i>';
                    window.localStorage.setItem('org.doubango.expert.disable_video', bDisableVideo);
                }
            }
        }
    
        function onDivCallCtrlMouseMove(evt) {
            try { // IE: DOM not ready
                if (tsk_utils_have_stream()) {
                    // btnCall.disabled = (!tsk_utils_have_stream() || !oSipSessionRegister || !oSipSessionRegister.is_connected());
                    document.getElementById("divCallCtrl").onmousemove = null; // unsubscribe
                }
            }
            catch (e) { }
        }
    
        function uiOnConnectionEvent(b_connected, b_connecting) { // should be enum: connecting, connected, terminating, terminated
            // btnRegister.disabled = b_connected || b_connecting;
            // btnUnRegister.disabled = !b_connected && !b_connecting;
            // btnCall.disabled = !(b_connected && tsk_utils_have_webrtc() && tsk_utils_have_stream());
            // btnHangUp.disabled = !oSipSessionCall;
        }
    
        function uiVideoDisplayEvent(b_local, b_added) {
            var o_elt_video = b_local ? videoLocal : videoRemote;
    
            if (b_added) {
                // o_elt_video.style.opacity = 1;
                uiVideoDisplayShowHide(true);
            }
            else {
                // o_elt_video.style.opacity = 0;
                fullScreen(false);
            }
        }
    
        function uiVideoDisplayShowHide(b_show) {
            if (b_show) {
                // tdVideo.style.height = '340px';
                // divVideo.style.height = navigator.appName == 'Microsoft Internet Explorer' ? '100%' : '340px';
            }
            else {
                // tdVideo.style.height = '0px';
                // divVideo.style.height = '0px';
            }
            // btnFullScreen.disabled = !b_show;
        }
    
        function uiDisableCallOptions() {
            if (window.localStorage) {
                window.localStorage.setItem('org.doubango.expert.disable_callbtn_options', 'true');
                uiBtnCallSetText('Call');
                alert('Use expert view to enable the options again (/!\\requires re-loading the page)');
            }
        }
    
        function uiBtnCallSetText(s_text) {
            switch (s_text) {
                case "Call":
                    {
                        var bDisableCallBtnOptions = (window.localStorage && window.localStorage.getItem('org.doubango.expert.disable_callbtn_options') == "true");
                        // btnCall.value = btnCall.innerHTML = bDisableCallBtnOptions ? 'Call' : 'Call <span id="spanCaret" class="caret">';
                        // btnCall.setAttribute("class", bDisableCallBtnOptions ? "btn btn-primary" : "btn btn-primary dropdown-toggle");
                        // btnCall.onclick = bDisableCallBtnOptions ? function () { sipCall(bDisableVideo ? 'call-audio' : 'call-audiovideo'); } : null;
                        // ulCallOptions.style.visibility = bDisableCallBtnOptions ? "hidden" : "visible";
                        // if (!bDisableCallBtnOptions && ulCallOptions.parentNode != divBtnCallGroup) {
                            // divBtnCallGroup.appendChild(ulCallOptions);
                        // }
                        // else if (bDisableCallBtnOptions && ulCallOptions.parentNode == divBtnCallGroup) {
                            // document.body.appendChild(ulCallOptions);
                        // }
    
                        break;
                    }
                default:
                    {
                        // btnCall.value = btnCall.innerHTML = s_text;
                        // btnCall.setAttribute("class", "btn btn-primary");
                        // btnCall.onclick = function () { sipCall(bDisableVideo ? 'call-audio' : 'call-audiovideo'); };
                        // ulCallOptions.style.visibility = "hidden";
                        // if (ulCallOptions.parentNode == divBtnCallGroup) {
                            // document.body.appendChild(ulCallOptions);
                        // }
                        break;
                    }
            }
        }
    
        function uiCallTerminated(s_description) {
            uiBtnCallSetText("Call");
            // btnHangUp.value = 'HangUp';
            // btnHoldResume.value = 'hold';
            // btnMute.value = "Mute";
            // btnCall.disabled = false;
            // btnHangUp.disabled = true;
            if (window.btnBFCP) window.btnBFCP.disabled = true;
    
            oSipSessionCall = null;
    
            stopRingbackTone();
            stopRingTone();
            console.log('uiCallTerminated s_description : ',s_description)
            // txtCallStatus.innerHTML = "<i>" + s_description + "</i>";
            uiVideoDisplayShowHide(false);
            // divCallOptions.style.opacity = 0;
    
            if (oNotifICall) {
                oNotifICall.cancel();
                oNotifICall = null;
            }
    
            uiVideoDisplayEvent(false, false);
            uiVideoDisplayEvent(true, false);
    
            setTimeout(function () { 
                if (!oSipSessionCall){} 
                //txtCallStatus.innerHTML = ''; 
            }, 2500);
        }
    
        // Callback function for SIP Stacks
        function onSipEventStack(e /*SIPml.Stack.Event*/) {
            tsk_utils_log_info('==stack event = ' + e.type);

            switch (e.type) {
                case 'started':
                    {
                        // catch exception for IE (DOM not ready)
                        try {
                            // LogIn (REGISTER) as soon as the stack finish starting
                            oSipSessionRegister = this.newSession('register', {
                                expires: 3600,
                                events_listener: { events: '*', listener: onSipEventSession },
                                sip_caps: [
                                            { name: '+g.oma.sip-im', value: null },
                                            //{ name: '+sip.ice' }, // rfc5768: FIXME doesn't work with Polycom TelePresence
                                            { name: '+audio', value: null },
                                            { name: 'language', value: '\"en,fr\"' }
                                ]
                            });
                            oSipSessionRegister.register();
                        }
                        catch (e) {
                            // txtRegStatus.value = txtRegStatus.innerHTML = "<b>1:" + e + "</b>";
                            // btnRegister.disabled = false;
                        }
                        break;
                    }
                case 'stopping': case 'stopped': case 'failed_to_start': case 'failed_to_stop':
                    {
                        var bFailure = (e.type == 'failed_to_start') || (e.type == 'failed_to_stop');
                        oSipStack = null;
                        oSipSessionRegister = null;
                        oSipSessionCall = null;
    
                        uiOnConnectionEvent(false, false);
    
                        stopRingbackTone();
                        stopRingTone();
    
                        uiVideoDisplayShowHide(false);
                        if(e.type == 'failed_to_start')
                            sipRegister();

                        if(e.type == "stopped"){
                            document.getElementById("alert-msg").innerText = "Not Connected";
                            document.getElementById("alert-msg").style.color = "red";
                            authUser("0", "0");
                        }
                        // divCallOptions.style.opacity = 0;
    
                        // txtCallStatus.innerHTML = '';
                        // txtRegStatus.innerHTML = bFailure ? "<i>Disconnected: <b>" + e.description + "</b></i>" : "<i>Disconnected</i>";
                        break;
                    }
    
                case 'i_new_call':
                    {
                        if (oSipSessionCall) {
                            // do not accept the incoming call if we're already 'in call'
                            e.newSession.hangup(); // comment this line for multi-line support
                        }
                        else {
                            oSipSessionCall = e.newSession;
                            // start listening for events
                            oSipSessionCall.setConfiguration(oConfigCall);
    
                            uiBtnCallSetText('Answer');
                            // btnHangUp.value = 'Reject';
                            // btnCall.disabled = false;
                            // btnHangUp.disabled = false;
    
                            startRingTone();

                            var sRemoteNumber = (oSipSessionCall.getRemoteFriendlyName() || 'unknown');
                            console.log('sRemoteNumber Incoming call from : ',sRemoteNumber)
                            //txtCallStatus.innerHTML = "<i>Incoming call from [<b>" + sRemoteNumber + "</b>]</i>";
                            showNotifICall(sRemoteNumber);
                            document.querySelector("#caller-number").value = String(sRemoteNumber).slice(-10);
                            if(fromPlatform == 'qkonnect') {
                                const myHeaders = new Headers();
                                myHeaders.append("Content-Type", "application/json");
                                
                                const raw = JSON.stringify({
                                  "api_key": userAPIKey,
                                  "caller_number": sRemoteNumber
                                });
                                
                                const requestOptions = {
                                  method: "POST",
                                  headers: myHeaders,
                                  body: raw,
                                  redirect: "follow"
                                };
                                
                                fetch("https://qkonnect.io/api/getContactName.php", requestOptions)
                                  .then((response) => response.json())
                                  .then((result) => {
                                        console.log(result, "get Call no")
                                        if(result.status == "200" && result?.data?.caller_name){
                                            document.getElementById("contact-name").innerText = result?.data?.caller_name;
                                        }else{
                                            document.getElementById("contact-name").innerText = 'Unknown';
                                        }
                                    })
                                  .catch((error) => console.error(error));
                            }else{
                                args = {
                                    apexClass: 'GetRecordId',
                                    methodName: 'getAccountId',
                                    methodParams: 'phoneNumber='+String(sRemoteNumber).slice(-10),
                                    callback: function(result) {
                                        if (result.success) {
                                            console.log('Result Incoming GetRecordId : ',result)
                                            console.log('Result: ',JSON.parse(result.returnValue.runApex).id);
                                            let rcrdId = JSON.parse(result.returnValue.runApex).id;
                                            idOfObject = JSON.parse(result.returnValue.runApex).id;
                                            document.getElementById("contact-name").innerText = JSON.parse(result.returnValue.runApex).name != "" ? JSON.parse(result.returnValue.runApex).name : "Unknown";
                                            sforce.opencti.screenPop({
                                            type: sforce.opencti.SCREENPOP_TYPE.SOBJECT,
                                            params: {
                                                        recordId: rcrdId
                                                    }
                                            });
                    
                                            
                                            
                                        } else {
                                            console.log('ResultError : ',result.errors);
                                        }
                                    }
                                };
                                // Call APEX Class to get
                                sforce.opencti.runApex(args)
                            }
                            
                            callType = "Incoming";
                            document.getElementById("contact-number").innerText = String(sRemoteNumber).slice(-10);
                            document.getElementById("dialed-number").value = String(sRemoteNumber).slice(-10);
                            
                            document.querySelector(".call-recieve").classList.remove("hide");
                            document.querySelector(".call-recieve").classList.add("show");
                            document.querySelector(".title").innerHTML = "Incoming";
    
                            hangupBtn.classList.add("hide")
                            hangupBtn.classList.remove("show")
                            
                            callRecieveBtns.classList.add("show")
                            callRecieveBtns.classList.remove("hide")

                            callInitStatus = "Ringing";

                            authUser("1", "1");
    
                            DialPad.call();
                            args = {
                                visible: true,
                                callback: function(result) {
                                    if (result.success) {
                                        console.log(result.returnValue);
                                    } else {
                                        console.log(result.errors);
                                    }
                                }
                            };

                            /*
                            window.parent.document.dispatchEvent(new CustomEvent('incomingCall', {
                                detail: {message: "Call Incoming"}
                            }))
                            */
                            sforce.opencti.setSoftphonePanelVisibility(args)

                            // Dialpad.call();
                        }
                        break;
                    }
    
                case 'm_permission_requested':
                    {
                        // divGlassPanel.style.visibility = 'visible';
                        break;
                    }
                case 'm_permission_accepted':
                case 'm_permission_refused':
                    {
                        // divGlassPanel.style.visibility = 'hidden';
                        if (e.type == 'm_permission_refused') {
                            uiCallTerminated('Media stream permission denied');
                        }
                        break;
                    }
    
                case 'starting': default: break;
            }
        };
    
        // Callback function for SIP sessions (INVITE, REGISTER, MESSAGE...)
        function onSipEventSession(e /* SIPml.Session.Event */) {
            tsk_utils_log_info('==session event = ' + e.type);

            switch (e.type) {
                case 'connecting': case 'connected':
                    {
                        if(callInitStatus == "Nothing" && e.type == "connected"){
                            document.getElementById("alert-msg").innerText = "Connected";
                            document.getElementById("alert-msg").style.color = "green";
                            authUser("1", "0");

                            if(dialingNumber != null && dialingNumber != '' && dialingNumber.length == 10){
                                DialPad.call();
                                document.querySelector(".title").innerHTML = "Calling";
                                document.querySelector("#dialed-number").value = dialingNumber;
                                document.querySelector("#caller-number").value = dialingNumber;
                                sipCall('call-audio', dialingNumber);
                            }
                        }
                        if(callInitStatus == "Ringing" && e.type == "connected"){
                            callInitStatus = "Connected"; 
                            document.querySelector(".title").innerHTML = "Connected ("+callType+")";
                            document.querySelector(".call-connected-options").classList.remove("hide");
                            document.querySelector(".call-connected-options").classList.add("show");
                            startCallTimer()
                            document.querySelector("#hold-btn").disabled = false;
                            document.querySelector("#mute-btn").disabled = false;
                            getUsers();
                        }
                        args = {
                            callback: function(result) {
                                console.log(result, "Click to dial result");
                            }
                        };
                        sforce.opencti.enableClickToDial(args);
                        var bConnected = (e.type == 'connected');
                        if (e.session == oSipSessionRegister) {
                            // uiOnConnectionEvent(bConnected, !bConnected);
                            // txtRegStatus.innerHTML = "<i>" + e.description + "</i>";
                        }
                        else if (e.session == oSipSessionCall) {
                            // btnHangUp.value = 'HangUp';
                            // btnCall.disabled = true;
                            // btnHangUp.disabled = false;
                            // btnTransfer.disabled = false;
                            if (window.btnBFCP) window.btnBFCP.disabled = false;
    
                            if (bConnected) {
                                stopRingbackTone();
                                stopRingTone();
    
                                if (oNotifICall) {
                                    oNotifICall.cancel();
                                    oNotifICall = null;
                                }
                            }
                            console.log(e.description, 'connected description')
                            // txtCallStatus.innerHTML = "<i>" + e.description + "</i>";
                            // divCallOptions.style.opacity = bConnected ? 1 : 0;
    
                            if (SIPml.isWebRtc4AllSupported()) { // IE don't provide stream callback
                                uiVideoDisplayEvent(false, true);
                                uiVideoDisplayEvent(true, true);
                            }
                        }
                        break;
                    } // 'connecting' | 'connected'
                case 'terminating': case 'terminated':
                    {
                        console.log(callInitStatus, 'call intiate status')
                        if(callInitStatus == "Nothing" && e.type == "terminated"){
                            document.getElementById("alert-msg").innerText = "Not Connected";
                            document.getElementById("alert-msg").style.color = "red";
                            authUser("0", "0");
                        }
                        
                        if((callInitStatus == "Call" || callInitStatus == "Ringing") && e.type == "terminated"){
                            setTimeout(()=>{
                                authUser("1", "0");
                            }, 1000);
                        }

                        if (e.session == oSipSessionRegister) {
                            // uiOnConnectionEvent(false, false);
    
                            oSipSessionCall = null;
                            oSipSessionRegister = null;
    
                            // txtRegStatus.innerHTML = "<i>" + e.description + "</i>";
                        }
                        else if (e.session == oSipSessionCall) {
                            uiCallTerminated(e.description);
                            sipHangUp();
                        }
    
                        break;
                    } // 'terminating' | 'terminated'
    
                case 'm_stream_video_local_added':
                    {
                        if (e.session == oSipSessionCall) {
                            uiVideoDisplayEvent(true, true);
                        }
                        break;
                    }
                case 'm_stream_video_local_removed':
                    {
                        if (e.session == oSipSessionCall) {
                            uiVideoDisplayEvent(true, false);
                        }
                        break;
                    }
                case 'm_stream_video_remote_added':
                    {
                        if (e.session == oSipSessionCall) {
                            uiVideoDisplayEvent(false, true);
                        }
                        break;
                    }
                case 'm_stream_video_remote_removed':
                    {
                        if (e.session == oSipSessionCall) {
                            uiVideoDisplayEvent(false, false);
                        }
                        break;
                    }
    
                case 'm_stream_audio_local_added':
                case 'm_stream_audio_local_removed':
                case 'm_stream_audio_remote_added':
                case 'm_stream_audio_remote_removed':
                    {
                        break;
                    }
    
                case 'i_ect_new_call':
                    {
                        oSipSessionTransferCall = e.session;
                        break;
                    }
    
                case 'i_ao_request':
                    {
                        if (e.session == oSipSessionCall) {
                            var iSipResponseCode = e.getSipResponseCode();
                            if (iSipResponseCode == 180 || iSipResponseCode == 183) {
                                //startRingbackTone();
                                // txtCallStatus.innerHTML = '<i>Remote ringing...</i>';
                                console.log("Remote ringing...")
                                document.querySelector(".title").innerHTML = "Ringing...";
                                callType = "Outgoing";
                                //stopRingbackTone();
                                callInitStatus = "Ringing";
                                authUser("1", "1");
                            }
                        }
                        break;
                    }
    
                case 'm_early_media':
                    {
                        if (e.session == oSipSessionCall) {
                            stopRingbackTone();
                            stopRingTone();
                            // txtCallStatus.innerHTML = '<i>Early media started</i>';
                            console.log("Early media started")
                        }
                        break;
                    }
    
                case 'm_local_hold_ok':
                    {
                        if (e.session == oSipSessionCall) {
                            if (oSipSessionCall.bTransfering) {
                                oSipSessionCall.bTransfering = false;
                                //this.AVSession.TransferCall(this.transferUri);
                            }
                            /*
                            btnHoldResume.value = 'Resume';
                            btnHoldResume.disabled = false;
                            txtCallStatus.innerHTML = '<i>Call placed on hold</i>';
                            oSipSessionCall.bHeld = true;
                            */
                            document.querySelector(".title").innerHTML += " (On Hold)";
                            document.getElementById('hold-btn').classList.add('active');
                            oSipSessionCall.bHeld = true;
                        }
                        break;
                    }
                case 'm_local_hold_nok':
                    {
                        if (e.session == oSipSessionCall) {
                            oSipSessionCall.bTransfering = false;
                            /*
                            btnHoldResume.value = 'Hold';
                            btnHoldResume.disabled = false;
                            txtCallStatus.innerHTML = '<i>Failed to place remote party on hold</i>';
                            */
                        }
                        document.querySelector(".title").innerHTML += " (Failed to place on hold)";
                        document.getElementById('hold-btn').classList.remove('active');
                        break;
                    }
                case 'm_local_resume_ok':
                    {
                        if (e.session == oSipSessionCall) {
                            oSipSessionCall.bTransfering = false;
                            /*
                            btnHoldResume.value = 'Hold';
                            btnHoldResume.disabled = false;
                            txtCallStatus.innerHTML = '<i>Call taken off hold</i>';
                            */
                            document.querySelector(".title").innerHTML = "Connected ("+callType+")";
                            document.getElementById('hold-btn').classList.remove('active');
                            oSipSessionCall.bHeld = false;
    
                            if (SIPml.isWebRtc4AllSupported()) { // IE don't provide stream callback yet
                                uiVideoDisplayEvent(false, true);
                                uiVideoDisplayEvent(true, true);
                            }
                        }
                        break;
                    }
                case 'm_local_resume_nok':
                    {
                        if (e.session == oSipSessionCall) {
                            oSipSessionCall.bTransfering = false;
                            /*
                            btnHoldResume.disabled = false;
                            txtCallStatus.innerHTML = '<i>Failed to unhold call</i>';
                            */
                            document.querySelector(".title").innerHTML += " (Failed to unhold call)";
                        }
                        break;
                    }
                case 'm_remote_hold':
                    {
                        if (e.session == oSipSessionCall) {
                            document.querySelector(".title").innerHTML += " (On Hold)";
                            /*
                            txtCallStatus.innerHTML = '<i>Placed on hold by remote party</i>';
                            */
                            document.getElementById('hold-btn').classList.add('active');
                        }
                        break;
                    }
                case 'm_remote_resume':
                    {
                        if (e.session == oSipSessionCall) {
                            document.querySelector(".title").innerHTML = "Connected ("+callType+")";
                            document.getElementById('hold-btn').classList.remove('active');
                            // txtCallStatus.innerHTML = '<i>Taken off hold by remote party</i>';
                        }
                        break;
                    }
                case 'm_bfcp_info':
                    {
                        if (e.session == oSipSessionCall) {
                            // txtCallStatus.innerHTML = 'BFCP Info: <i>' + e.description + '</i>';
                        }
                        break;
                    }
    
                case 'o_ect_trying':
                    {
                        if (e.session == oSipSessionCall) {
                            // txtCallStatus.innerHTML = '<i>Call transfer in progress...</i>';
                            console.log("Call transfer in progress...");
                        }
                        break;
                    }
                case 'o_ect_accepted':
                    {
                        if (e.session == oSipSessionCall) {
                            // txtCallStatus.innerHTML = '<i>Call transfer accepted</i>';
                            console.log("Call transfer accepted");
                        }
                        break;
                    }
                case 'o_ect_completed':
                case 'i_ect_completed':
                    {
                        if (e.session == oSipSessionCall) {
                            // txtCallStatus.innerHTML = '<i>Call transfer completed</i>';
                            console.log("Call transfer completed")
                            // btnTransfer.disabled = false;
                            if (oSipSessionTransferCall) {
                                oSipSessionCall = oSipSessionTransferCall;
                            }
                            oSipSessionTransferCall = null;
                        }
                        break;
                    }
                case 'o_ect_failed':
                case 'i_ect_failed':
                    {
                        if (e.session == oSipSessionCall) {
                            console.log("Call transfer failed")
                            // txtCallStatus.innerHTML = '<i>Call transfer failed</i>';
                            // btnTransfer.disabled = false;
                        }
                        break;
                    }
                case 'o_ect_notify':
                case 'i_ect_notify':
                    {
                        if (e.session == oSipSessionCall) {
                            console.log("Call Transfer: <b>" + e.getSipResponseCode(), "Description : ",e.description)
                            // txtCallStatus.innerHTML = "<i>Call Transfer: <b>" + e.getSipResponseCode() + " " + e.description + "</b></i>";
                            if (e.getSipResponseCode() >= 300) {
                                if (oSipSessionCall.bHeld) {
                                    oSipSessionCall.resume();
                                }
                                // btnTransfer.disabled = false;
                            }
                        }
                        break;
                    }
                case 'i_ect_requested':
                    {
                        if (e.session == oSipSessionCall) {
                            var s_message = "Do you accept call transfer to [" + e.getTransferDestinationFriendlyName() + "]?";//FIXME
                            if (confirm(s_message)) {
                                // txtCallStatus.innerHTML = "<i>Call transfer in progress...</i>";
                                oSipSessionCall.acceptTransfer();
                                break;
                            }
                            oSipSessionCall.rejectTransfer();
                        }
                        break;
                    }
            }
        }
        
    </script>
    <script type="text/javascript">
        document.querySelector("#call-init").addEventListener("click", ()=>{
            const isConnectedMsg = document.getElementById("alert-msg").innerText;
            if(isConnectedMsg == "Waiting for connection" || isConnectedMsg == "Not Connected" || isConnectedMsg == "Unable to connect" || isConnectedMsg.includes('no')){
                return;
            }
            document.querySelector(".title").innerHTML = "Calling";
            let phoneNumber = document.querySelector("#dialed-number").value;
            document.querySelector("#caller-number").value = phoneNumber;

            if(fromPlatform == 'qkonnect'){
                const myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");
                
                const raw = JSON.stringify({
                  "api_key": userAPIKey,
                  "caller_number": phoneNumber
                });
                
                const requestOptions = {
                  method: "POST",
                  headers: myHeaders,
                  body: raw,
                  redirect: "follow"
                };
                
                fetch("https://qkonnect.io/api/getContactName.php", requestOptions)
                  .then((response) => response.json())
                  .then((result) => {
                        console.log(result, "get Call no")
                        if(result.status == "200" && result?.data?.caller_name){
                            document.getElementById("contact-name").innerText = result?.data?.caller_name;
                        }else{
                            document.getElementById("contact-name").innerText = 'Unknown';
                        }
                    })
                  .catch((error) => console.error(error));
            }else{
                args = {
                    apexClass: 'GetRecordId',
                    methodName: 'getAccountId',
                    methodParams: 'phoneNumber='+phoneNumber,
                    callback: function(result) {
                        if (result.success) {
                            console.log('Result Dialed GetRecordId : ',result)
                            console.log('Result: ',JSON.parse(result.returnValue.runApex).id);
                            let rcrdId = JSON.parse(result.returnValue.runApex).id;
                            idOfObject = JSON.parse(result.returnValue.runApex).id;
                            document.getElementById("contact-name").innerText = JSON.parse(result.returnValue.runApex).name != "" ? JSON.parse(result.returnValue.runApex).name : "Unknown";
                            sforce.opencti.screenPop({
                            type: sforce.opencti.SCREENPOP_TYPE.SOBJECT,
                            params: {
                                        recordId: rcrdId
                                    }
                            });
    
                            
                            
                        } else {
                            console.log('ResultError : ',result.errors);
                        }
                    }
                };
                // Call APEX Class to get
                sforce.opencti.runApex(args)  
            }

            // console.log('call init')
            sipCall('call-audio', phoneNumber)
        })

        function getSelectedAgents() {
            // Get the select element
            var selectElement = document.getElementById("agents-for-conferance");
            
            // Create an empty array to hold selected values
            var selectedAgents = [];
            
            // Loop through the options in the select element
            for (var i = 0; i < selectElement.options.length; i++) {
                // If the option is selected, push its value to the array
                if (selectElement.options[i].selected) {
                    selectedAgents.push(selectElement.options[i].value);
                }
            }
            
            // Return or log the array of selected agents
            return selectedAgents;
        }

        async function callTransfer(transferType){
            try{
                let connectionType = "";
                console.log('type : ',transferType)
                let toExtension;
                if(transferType == 'transfer'){
                    const transferAgentElem = document.getElementById("agents-for-transfer");
                    toExtension = [String(transferAgentElem.value)];
                    connectionType = "transfer";
                }else if(transferType == 'conferance'){
                    toExtension = getSelectedAgents();
                    connectionType = "multiway";
                }

                if(transferType == 'conferance'){
                    toExtension = toExtension.filter((ext) => { return ext != "" });
                }

                if(transferType == 'conferance'  && toExtension.length > 5){
                    alert("You can only add 5 agents for conference");
                    return;
                }

                console.log("toExtension : ",toExtension);

                if(transferType == 'transfer' && toExtension == ''){
                    alert("Please select an agent to transfer this call");
                    return;
                }else if(transferType == 'conferance' && toExtension.length == 0){
                    alert("Please select at least one agent to conferance this call");
                    return;
                }

                const data = JSON.stringify({
                    "api_key": userAPIKey,
                    "fromnumber": userExtension, // "974983"
                    "type": connectionType, // transfer , multiway
                    "destnumber": toExtension // conferance - ["698325","85798"], transfer - ["798324"], "364287"
                });

                console.log("call transfer body : ",data);

                const requestOptions = {
                    method: "POST",
                    Headers: {
                        "Accept": '*/*',
                        'Content-Type': 'application/json',
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow-Headers":"X-Requested-With"
                    },
                    body: data,
                    redirect: "follow"
                };

                // fetch("https://qkonnect.io/api/ashirwaadSalesforceIncallTransfer.php", requestOptions)
                fetch("https://qkonnect.io/api/testqk.php", requestOptions)
                .then((response) => response.json())
                .then((result) => {
                    console.log(result, "Call Transfer Response")
                    if(result.status_code == 200){
                        authUser("1", "0");
                    }
                })
                .catch((error) => console.error(error));
            }catch(error){
                console.log("catch error : ",error)
            }
        }

        function newCase(){
            sforce.opencti.screenPop({
                type: sforce.opencti.SCREENPOP_TYPE.URL,
                params: {
                    url: '/lightning/o/Case/list?filterName=__Recent'
                },
                callback: function(response) {
                    console.log("new case respionse : ",response)
                    if (response.success) {
                        console.log("Screen pop successful");
                    } else {
                        console.error("Screen pop failed: ", response.errors);
                    }
                }
            });
        }
    </script>
    
</body> 
</html>